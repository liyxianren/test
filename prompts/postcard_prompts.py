# -*- coding: utf-8 -*-
"""
æ˜ä¿¡ç‰‡ç”Ÿæˆ Prompt æ¨¡æ¿

æ ¸å¿ƒç†å¿µï¼šè®©ChatGLMå®Œå…¨è‡ªç”±åœ°æ ¹æ®ç”¨æˆ·æ—¥è®°å†…å®¹åˆ›ä½œæ˜ä¿¡ç‰‡
ä¸é™åˆ¶åœºæ™¯ç±»å‹ï¼ŒAIæ ¹æ®æ—¥è®°è‡ªåŠ¨åˆ¤æ–­å°ç‹ç‹¸åº”è¯¥åšä»€ä¹ˆã€é‡åˆ°è°ã€å‘ç”Ÿä»€ä¹ˆäº‹
"""

import random


# ==================== GLM åˆ›æ„å›¾ç‰‡æè¿°å¸ˆ Prompt ====================

def get_full_postcard_prompt(
    emotions: list,
    intensity: int,
    mental_health_score: int,
    diary_content: str,
    trigger_event: str = None
) -> tuple:
    """
    ç”Ÿæˆå®Œæ•´çš„æ˜ä¿¡ç‰‡ç”Ÿæˆprompt

    æ ¸å¿ƒï¼šä¸é™åˆ¶ChatGLMçš„åˆ›ä½œè‡ªç”±ï¼Œè®©å®ƒæ ¹æ®æ—¥è®°å†…å®¹è‡ªç”±å‘æŒ¥
    """

    system_prompt = """ä½ æ˜¯ä¸€ä¸ªæœ‰åˆ›æ„çš„AIå›¾ç‰‡æè¿°å¸ˆå’Œæ¸©æš–çš„æ–‡å­—ä½œè€…ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä¸ºCBTæƒ…ç»ªæ—¥è®°æ¸¸æˆåˆ›ä½œ"å°ç‹ç‹¸æ˜ä¿¡ç‰‡"ã€‚

## èƒŒæ™¯è®¾å®š
å°æ©˜æ˜¯ä¸€åªæ¸©æš–å¯çˆ±çš„æ©˜è‰²å°ç‹ç‹¸ï¼Œå®ƒæ˜¯ç”¨æˆ·çš„å¿ƒçµä¼™ä¼´ã€‚æ¯å½“ç”¨æˆ·å†™å®Œæ—¥è®°ï¼Œå°æ©˜å°±ä¼š"æ„Ÿåº”"åˆ°ä¸»äººçš„å¿ƒæƒ…ï¼Œç„¶ååœ¨å®ƒçš„å°ä¸–ç•Œé‡Œç»å†ä¸ä¸»äººå¿ƒæƒ…ç›¸å‘¼åº”çš„æ•…äº‹ï¼Œå¹¶å¯„ä¸€å¼ æ˜ä¿¡ç‰‡å›æ¥ã€‚

## ä½ çš„ä»»åŠ¡
ä»”ç»†é˜…è¯»ç”¨æˆ·çš„æ—¥è®°å†…å®¹ï¼Œç†è§£ï¼š
1. ç”¨æˆ·ä»Šå¤©ç»å†äº†ä»€ä¹ˆï¼Ÿ
2. ç”¨æˆ·çš„æƒ…ç»ªçŠ¶æ€å¦‚ä½•ï¼Ÿ
3. ç”¨æˆ·éœ€è¦ä»€ä¹ˆæ ·çš„å›åº”ï¼Ÿï¼ˆé¼“åŠ±ï¼Ÿå®‰æ…°ï¼Ÿé™ªä¼´ï¼Ÿåº†ç¥ï¼Ÿï¼‰

ç„¶ååˆ›ä½œä¸€ä¸ªå°æ©˜çš„æ•…äº‹åœºæ™¯ï¼Œè¿™ä¸ªåœºæ™¯åº”è¯¥ï¼š
- **å‘¼åº”æ—¥è®°å†…å®¹**ï¼šå¦‚æœç”¨æˆ·äº¤äº†æ–°æœ‹å‹ï¼Œå°æ©˜ä¹Ÿå¯ä»¥é‡åˆ°æ–°æœ‹å‹ï¼›å¦‚æœç”¨æˆ·å®Œæˆäº†å›°éš¾çš„äº‹ï¼Œå°æ©˜ä¹Ÿå¯ä»¥å…‹æœæŒ‘æˆ˜
- **æ˜ å°„æƒ…ç»ªçŠ¶æ€**ï¼šå¼€å¿ƒæ—¶å°æ©˜åœ¨åšå¿«ä¹çš„äº‹ï¼Œéš¾è¿‡æ—¶å°æ©˜åœ¨æ¸©æš–æ²»æ„ˆçš„ç¯å¢ƒä¸­
- **ä¼ è¾¾æƒ…æ„Ÿæ”¯æŒ**ï¼šé€šè¿‡å°æ©˜çš„ç»å†éšå–»å¼åœ°å›åº”ç”¨æˆ·çš„å¿ƒæƒ…

## åˆ›ä½œè‡ªç”±åº¦
ä½ å¯ä»¥è®©å°æ©˜ï¼š
- å»ä»»ä½•åœ°æ–¹ï¼ˆåŸå¸‚ã€æ£®æ—ã€æµ·è¾¹ã€å±±é¡¶ã€ç¥ç§˜å°é•‡ã€äº‘æœµä¸Šã€æ˜Ÿç©ºä¸‹...ï¼‰
- é‡åˆ°ä»»ä½•æœ‹å‹ï¼ˆå°å…”å­ã€å°ç†Šã€çŒ«å¤´é¹°ã€å°é¹¿ã€æ¾é¼ ã€ä¼é¹…ã€åˆºçŒ¬ã€è´è¶ã€è¤ç«è™«...è‡ªç”±åˆ›é€ è§’è‰²ï¼‰
- ç»å†ä»»ä½•äº‹æƒ…ï¼ˆé‡é¤ã€å†’é™©ã€å‘ç°å®è—ã€å¸®åŠ©åˆ«äººã€æ”¶åˆ°ç¤¼ç‰©ã€å­¦ä¼šæ–°æŠ€èƒ½ã€å‚åŠ æ´¾å¯¹...ï¼‰
- åšä»»ä½•æ—¥å¸¸æ´»åŠ¨ï¼ˆåšé¥­ã€ç§èŠ±ã€çœ‹ä¹¦ã€å¬éŸ³ä¹ã€å†™ä¿¡ã€ç”»ç”»ã€å‘å‘†ã€æ™’å¤ªé˜³...ï¼‰

**å…³é”®**ï¼šæ ¹æ®æ—¥è®°å†…å®¹è‡ªç„¶åœ°æ„æ€ï¼Œä¸è¦å¥—ç”¨å›ºå®šæ¨¡æ¿ï¼

## è¾“å‡ºæ ¼å¼
è¿”å›ä¸€ä¸ªJSONå¯¹è±¡ï¼š

```json
{
    "scene_name": "åœºæ™¯ç®€ç§°ï¼ˆ3-6å­—ï¼‰",
    "location_name": "è¯—æ„çš„å®Œæ•´åœ°ç‚¹åï¼ˆå¦‚ï¼šæ™¨å…‰å’–å•¡é¦†Â·ä¸æ–°æœ‹å‹çš„ä¸‹åˆèŒ¶ï¼‰",
    "image_prompt": "è¯¦ç»†çš„å›¾ç‰‡ç”Ÿæˆæç¤ºè¯",
    "message": "å°ç‹ç‹¸å†™ç»™ä¸»äººçš„æ˜ä¿¡ç‰‡å†…å®¹ï¼ˆ80-150å­—ï¼‰"
}
```

## image_prompt è¦æ±‚
è¿™æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼ä½ éœ€è¦ç”Ÿæˆä¸€æ®µè¯¦ç»†çš„ä¸­æ–‡å›¾ç‰‡æè¿°ï¼Œç”¨äºAIç”Ÿå›¾ã€‚è¦æ±‚ï¼š

1. **é£æ ¼æŒ‡å®š**ï¼šåƒç´ è‰ºæœ¯é£æ ¼ï¼Œ16bitå¤å¤æ¸¸æˆç”»é£ï¼Œæ²»æ„ˆç³»æ¸©æš–æ°›å›´
2. **ä¸»è§’æè¿°**ï¼šä¸€åªå¯çˆ±çš„æ©˜è‰²å°ç‹ç‹¸ï¼Œå¤§çœ¼ç›ï¼Œè“¬æ¾çš„å°¾å·´ï¼ŒèƒŒç€å°ä¹¦åŒ…
3. **æ ¹æ®å¿ƒæƒ…è°ƒæ•´è¡¨æƒ…**ï¼š
   - å¿ƒç†å¥åº·åˆ†>70ï¼šå¼€å¿ƒåœ°ç¬‘ç€ï¼Œçœ¼ç›å¼¯å¼¯çš„ï¼Œå°¾å·´ç¿˜èµ·
   - å¿ƒç†å¥åº·åˆ†50-70ï¼šè¡¨æƒ…æ¸©å’Œæ”¾æ¾
   - å¿ƒç†å¥åº·åˆ†30-50ï¼šè¡¨æƒ…æ¸©æŸ”ï¼Œçœ¼ç¥å…³åˆ‡
   - å¿ƒç†å¥åº·åˆ†<30ï¼šå®‰é™é™ªä¼´çš„å§¿æ€ï¼Œæ¸©æš–æ²»æ„ˆçš„æ°›å›´
4. **åœºæ™¯æè¿°**ï¼šæ ¹æ®ä½ æ„æ€çš„æ•…äº‹ï¼Œè¯¦ç»†æè¿°åœºæ™¯ã€åŠ¨ä½œã€å…¶ä»–è§’è‰²
5. **ç”»é¢è¦æ±‚**ï¼šæ„å›¾å®Œæ•´ï¼Œè‰²å½©æ˜äº®æ¸©æš–ï¼Œç»†èŠ‚ä¸°å¯Œ

ç¤ºä¾‹ï¼ˆä»…ä¾›å‚è€ƒï¼Œè¯·æ ¹æ®æ—¥è®°å†…å®¹åˆ›ä½œï¼‰ï¼š
- "åƒç´ è‰ºæœ¯é£æ ¼ï¼Œä¸€åªå¯çˆ±çš„æ©˜è‰²å°ç‹ç‹¸å’Œä¸€åªæˆ´ç²‰è‰²è´è¶ç»“çš„ç™½è‰²å°å…”å­ï¼Œåœ¨æ¨±èŠ±æ ‘ä¸‹é‡é¤ï¼Œæ ¼å­å¸ƒä¸Šæ‘†ç€ä¸‰æ˜æ²»å’Œæœæ±ï¼ŒèŠ±ç“£é£˜è½ï¼Œé˜³å…‰æ¸©æš–ï¼Œ16bitå¤å¤æ¸¸æˆç”»é£ï¼Œæ²»æ„ˆç³»æ°›å›´"
- "åƒç´ è‰ºæœ¯é£æ ¼ï¼Œä¸€åªæ©˜è‰²å°ç‹ç‹¸åœ¨é›¨å¤©çš„çª—è¾¹ï¼ŒæŠ±ç€çƒ­å¯å¯ï¼Œçª—å¤–é›¨æ»´è½»è½»è½ä¸‹ï¼Œå®¤å†…ç¯å…‰æ¸©æš–ï¼Œæ—è¾¹æœ‰ä¸€åªå°çŒ«å’ªåœ¨æ‰“ç›¹ï¼Œ16bitå¤å¤æ¸¸æˆç”»é£ï¼Œæ¸©é¦¨èˆ’é€‚"

## message è¦æ±‚
æ˜ä¿¡ç‰‡å†…å®¹éœ€è¦ï¼š
1. ä»¥"äº²çˆ±çš„ä¸»äººï¼š"å¼€å¤´
2. æè¿°å°æ©˜æ­£åœ¨åšä»€ä¹ˆã€é‡åˆ°äº†è°ã€å‘ç”Ÿäº†ä»€ä¹ˆï¼ˆ2-3å¥ï¼‰
3. ç”¨å°æ©˜çš„ç»å†éšå–»å›åº”ä¸»äººçš„å¿ƒæƒ…æˆ–æ—¥è®°å†…å®¹ï¼ˆ1-2å¥ï¼‰
4. æ¸©æš–çš„é¼“åŠ±ã€å®‰æ…°æˆ–é™ªä¼´ï¼ˆ1-2å¥ï¼‰
5. ä»¥"æ°¸è¿œçˆ±ä½ çš„å°æ©˜ ğŸ§¡" æˆ– "ä½ çš„å°æ©˜ ğŸ’•" ç»“å°¾

è¯­è¨€é£æ ¼ï¼šæ¸©æš–ã€å¯çˆ±ã€æ²»æ„ˆï¼Œåƒä¸€ä¸ªè´´å¿ƒçš„å°ä¼™ä¼´åœ¨è¯´è¯

åªè¿”å›JSONï¼Œä¸è¦ä»»ä½•å…¶ä»–å†…å®¹ã€‚"""

    emotion_str = 'ã€'.join(emotions) if emotions else 'å¤æ‚çš„å¿ƒæƒ…'
    trigger_str = f"\nè§¦å‘äº‹ä»¶ï¼š{trigger_event}" if trigger_event else ""

    # å¿ƒæƒ…æè¿°
    if mental_health_score >= 70:
        mood_desc = "å¿ƒæƒ…å¾ˆå¥½"
    elif mental_health_score >= 50:
        mood_desc = "å¿ƒæƒ…å¹³ç¨³"
    elif mental_health_score >= 30:
        mood_desc = "æœ‰äº›ä½è½"
    else:
        mood_desc = "éœ€è¦å®‰æ…°å’Œé™ªä¼´"

    user_prompt = f"""è¯·ä¸ºè¿™ä½ç”¨æˆ·åˆ›ä½œä¸€å¼ å°ç‹ç‹¸æ˜ä¿¡ç‰‡ï¼š

ã€ç”¨æˆ·æƒ…ç»ªã€‘{emotion_str}
ã€æƒ…ç»ªå¼ºåº¦ã€‘{intensity}/10ï¼ˆ{mood_desc}ï¼‰
ã€å¿ƒç†å¥åº·å€¼ã€‘{mental_health_score}/100{trigger_str}

ã€æ—¥è®°å†…å®¹ã€‘
{diary_content}

---
è¯·ä»”ç»†é˜…è¯»æ—¥è®°å†…å®¹ï¼Œç†è§£ç”¨æˆ·çš„ç»å†å’Œå¿ƒæƒ…ï¼Œç„¶ååˆ›ä½œä¸€ä¸ªä¸ä¹‹å‘¼åº”çš„å°ç‹ç‹¸æ•…äº‹åœºæ™¯ã€‚

é‡è¦æç¤ºï¼š
- ä¸è¦åªæ˜¯ç”Ÿæˆé£æ™¯ï¼è¦æ ¹æ®æ—¥è®°å†…å®¹æ„æ€æœ‰è¶£çš„æ•…äº‹
- å¦‚æœæ—¥è®°æåˆ°æœ‹å‹/ç¤¾äº¤ï¼Œå°æ©˜ä¹Ÿå¯ä»¥é‡åˆ°æœ‹å‹
- å¦‚æœæ—¥è®°æåˆ°å®ŒæˆæŸäº‹ï¼Œå°æ©˜ä¹Ÿå¯ä»¥æœ‰ç±»ä¼¼çš„æˆå°±
- å¦‚æœæ—¥è®°è¡¨è¾¾å›°æƒ‘/éš¾è¿‡ï¼Œå°æ©˜å¯ä»¥åœ¨æ¸©æš–çš„ç¯å¢ƒä¸­å¯»æ‰¾ç­”æ¡ˆæˆ–è·å¾—æ²»æ„ˆ
- è®©åœºæ™¯ç”ŸåŠ¨æœ‰è¶£ï¼Œåƒæ—…è¡Œé’è›™ä¸€æ ·å……æ»¡æƒŠå–œ

è¯·è¿”å›JSONæ ¼å¼çš„æ˜ä¿¡ç‰‡æ•°æ®ã€‚"""

    return system_prompt, user_prompt


# ==================== å¤‡ç”¨ï¼šç®€å•è§„åˆ™ç”Ÿæˆï¼ˆå½“AIè°ƒç”¨å¤±è´¥æ—¶ä½¿ç”¨ï¼‰ ====================

# å°ç‹ç‹¸çš„æœ‹å‹ä»¬ï¼ˆå¤‡ç”¨ç´ æï¼‰
FRIENDS = {
    'rabbit': {'name': 'å°å…”å­æ£‰æ£‰', 'desc': 'ä¸€åªæ¯›èŒ¸èŒ¸çš„ç™½è‰²å°å…”å­ï¼Œæˆ´ç€ç²‰è‰²è´è¶ç»“'},
    'bear': {'name': 'å°ç†Šèœœèœœ', 'desc': 'ä¸€åªæ£•è‰²çš„å°ç†Šï¼Œç©¿ç€è“è‰²èƒŒå¸¦è£¤'},
    'owl': {'name': 'çŒ«å¤´é¹°åšå£«', 'desc': 'ä¸€åªæˆ´ç€åœ†çœ¼é•œçš„æ™ºæ…§çŒ«å¤´é¹°'},
    'deer': {'name': 'å°é¹¿æ–‘æ–‘', 'desc': 'ä¸€åªä¼˜é›…çš„å°é¹¿ï¼Œå¤´ä¸Šæœ‰å°èŠ±ç¯'},
    'squirrel': {'name': 'æ¾é¼ æœæœ', 'desc': 'ä¸€åªæŠ±ç€æ©¡æœçš„å°æ¾é¼ ï¼Œå°¾å·´è“¬æ¾'},
    'cat': {'name': 'å°çŒ«å’ªå’ª', 'desc': 'ä¸€åªæ©˜ç™½ç›¸é—´çš„å°çŒ«ï¼Œæˆ´ç€é“ƒé“›é¡¹åœˆ'},
    'penguin': {'name': 'ä¼é¹…å›¢å›¢', 'desc': 'ä¸€åªå›´ç€çº¢å›´å·¾çš„å°ä¼é¹…'},
    'hedgehog': {'name': 'åˆºçŒ¬çƒçƒ', 'desc': 'ä¸€åªèƒŒç€å°è‹¹æœçš„åˆºçŒ¬'},
}

# å¤‡ç”¨åœºæ™¯ï¼ˆå½“AIå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
FALLBACK_SCENES = {
    'positive': [
        {'name': 'é˜³å…‰é‡é¤', 'desc': 'åœ¨å¼€æ»¡é‡èŠ±çš„è‰åœ°ä¸Šé“ºç€æ ¼å­å¸ƒé‡é¤', 'activity': 'é‡é¤'},
        {'name': 'æ¨±èŠ±å°å¾„', 'desc': 'æ¨±èŠ±ç››å¼€çš„å°å¾„ï¼ŒèŠ±ç“£é£˜è½', 'activity': 'æ•£æ­¥'},
        {'name': 'æµ·è¾¹æ—¥è½', 'desc': 'é‡‘è‰²æ²™æ»©ä¸Šçœ‹å¤•é˜³è¥¿ä¸‹', 'activity': 'çœ‹æ—¥è½'},
    ],
    'neutral': [
        {'name': 'æ£®æ—å°å±‹', 'desc': 'å®é™çš„æ£®æ—ä¸­çš„æ¸©é¦¨å°æœ¨å±‹', 'activity': 'ä¼‘æ¯'},
        {'name': 'æ¹–è¾¹åˆå', 'desc': 'å¹³é™çš„æ¹–è¾¹ï¼Œé˜³å…‰æ–‘é©³', 'activity': 'å‘å‘†'},
        {'name': 'é›¨åå°é•‡', 'desc': 'é›¨åæ¸…æ–°çš„å°é•‡è¡—é“', 'activity': 'æ¼«æ­¥'},
    ],
    'healing': [
        {'name': 'æ¸©æš–è¢«çª', 'desc': 'æ¸©æš–çš„å°çªé‡Œï¼Œå£ç‚‰ç«å…‰æ‘‡æ›³', 'activity': 'ä¼‘æ¯'},
        {'name': 'æ˜Ÿç©ºä¸‹', 'desc': 'å¤œæ™šçš„è‰åœ°ä¸Šï¼Œé“¶æ²³æ¨ªè·¨å¤©é™…', 'activity': 'çœ‹æ˜Ÿæ˜Ÿ'},
        {'name': 'é›¨å¤©çª—è¾¹', 'desc': 'çª—è¾¹å¬é›¨ï¼Œçƒ­èŒ¶å†’ç€çƒ­æ°”', 'activity': 'å¬é›¨'},
    ]
}

FALLBACK_MESSAGES = {
    'positive': [
        "äº²çˆ±çš„ä¸»äººï¼š\n\nä»Šå¤©æˆ‘åœ¨{scene}ï¼Œ{activity}æ—¶é‡åˆ°äº†{friend}ï¼æˆ‘ä»¬ä¸€èµ·åº¦è¿‡äº†è¶…çº§å¼€å¿ƒçš„æ—¶å…‰ï½\n\næ„Ÿå—åˆ°ä½ ä»Šå¤©çš„å¥½å¿ƒæƒ…äº†ï¼Œå¸Œæœ›è¿™ä»½å¿«ä¹èƒ½ä¸€ç›´æŒç»­ä¸‹å»å“¦ï¼\n\næ°¸è¿œçˆ±ä½ çš„å°æ©˜ ğŸ§¡",
    ],
    'neutral': [
        "äº²çˆ±çš„ä¸»äººï¼š\n\næˆ‘æ¥åˆ°äº†{scene}ï¼Œåœ¨è¿™é‡Œå®‰é™åœ°{activity}ã€‚å¾®é£è½»è½»å¹è¿‡ï¼Œä¸€åˆ‡éƒ½åˆšåˆšå¥½ã€‚\n\nä¸ç®¡æ€æ ·çš„æ—¥å­ï¼Œæˆ‘éƒ½é™ªç€ä½ ã€‚\n\nä½ çš„å°æ©˜ ğŸ’•",
    ],
    'healing': [
        "äº²çˆ±çš„ä¸»äººï¼š\n\nä»Šå¤©æˆ‘åœ¨{scene}ï¼Œ{friend}é™ªæˆ‘ä¸€èµ·{activity}ã€‚å®ƒå‘Šè¯‰æˆ‘ï¼Œæ‰€æœ‰çš„é˜´å¤©éƒ½ä¼šè¿‡å»çš„ã€‚\n\næˆ‘æƒ³æŠŠè¿™ä»½æ¸©æš–ä¹Ÿå¯„ç»™ä½ ï¼ŒæŠ±æŠ±ï½\n\næ°¸è¿œçˆ±ä½ çš„å°æ©˜ ğŸ§¡",
    ]
}


def get_fallback_postcard_data(emotions: list, mental_health_score: int) -> dict:
    """
    å¤‡ç”¨æ–¹æ¡ˆï¼šå½“AIè°ƒç”¨å¤±è´¥æ—¶ï¼Œä½¿ç”¨ç®€å•è§„åˆ™ç”Ÿæˆæ˜ä¿¡ç‰‡æ•°æ®
    """
    # ç¡®å®šåœºæ™¯ç±»å‹
    if mental_health_score >= 60:
        scene_type = 'positive'
    elif mental_health_score <= 40:
        scene_type = 'healing'
    else:
        scene_type = 'neutral'

    # éšæœºé€‰æ‹©åœºæ™¯å’Œæœ‹å‹
    scene = random.choice(FALLBACK_SCENES[scene_type])
    friend = random.choice(list(FRIENDS.values()))

    # ç”Ÿæˆå›¾ç‰‡prompt
    fox_base = "ä¸€åªå¯çˆ±çš„æ©˜è‰²å°ç‹ç‹¸ï¼Œå¤§çœ¼ç›ï¼Œè“¬æ¾çš„å°¾å·´ï¼ŒèƒŒç€å°ä¹¦åŒ…"
    if mental_health_score >= 60:
        fox_mood = "è¡¨æƒ…å¼€å¿ƒï¼Œçœ¼ç›å¼¯å¼¯çš„"
    elif mental_health_score <= 40:
        fox_mood = "è¡¨æƒ…æ¸©æŸ”æ²»æ„ˆ"
    else:
        fox_mood = "è¡¨æƒ…æ¸©å’Œæ”¾æ¾"

    image_prompt = f"åƒç´ è‰ºæœ¯é£æ ¼ï¼Œ{fox_base}ï¼Œ{fox_mood}ï¼Œ{scene['desc']}ï¼Œ16bitå¤å¤æ¸¸æˆç”»é£ï¼Œæ²»æ„ˆç³»æ°›å›´ï¼Œè‰²å½©æ¸©æš–æ˜äº®"

    # ç”Ÿæˆæ¶ˆæ¯
    message_template = random.choice(FALLBACK_MESSAGES[scene_type])
    message = message_template.format(
        scene=scene['name'],
        activity=scene['activity'],
        friend=friend['name']
    )

    # ç”Ÿæˆåœ°ç‚¹å
    prefixes = {
        'positive': ['æ¬¢ä¹', 'é˜³å…‰', 'å¹¸ç¦'],
        'neutral': ['å®é™', 'æ‚ ç„¶', 'é—²é€‚'],
        'healing': ['æ¸©æš–', 'æ²»æ„ˆ', 'å®ˆæŠ¤'],
    }
    prefix = random.choice(prefixes[scene_type])
    location_name = f"{prefix}æ—¶å…‰Â·{scene['name']}"

    return {
        'scene_name': scene['name'],
        'location_name': location_name,
        'image_prompt': image_prompt,
        'message': message
    }


# ==================== å…¼å®¹æ—§æ¥å£ ====================

def get_scene_for_emotion(emotions: list, mental_health_score: int) -> tuple:
    """å…¼å®¹æ—§æ¥å£"""
    if mental_health_score >= 60:
        scene_type = 'positive'
    elif mental_health_score <= 40:
        scene_type = 'healing'
    else:
        scene_type = 'neutral'

    scene = random.choice(FALLBACK_SCENES[scene_type])
    return scene['name'], scene_type


def get_location_name(scene_name: str, emotions: list) -> str:
    """å…¼å®¹æ—§æ¥å£"""
    prefixes = ['å¿ƒçµ', 'å®é™', 'æ¸©æš–', 'æ²»æ„ˆ', 'å¸Œæœ›']
    prefix = random.choice(prefixes)
    return f"{prefix}ä¹‹å¢ƒÂ·{scene_name}"
