# -*- coding: utf-8 -*-
"""
æ˜ä¿¡ç‰‡ç”Ÿæˆ Prompt æ¨¡æ¿

æ ¸å¿ƒç†å¿µï¼šå°ç‹ç‹¸é€šè¿‡è®²è¿°è‡ªå·±çš„å°æ•…äº‹æ¥é™ªä¼´ç”¨æˆ·
ä¸æ˜¯ç›´æ¥è¯´æ•™å¼çš„å®‰æ…°ï¼Œè€Œæ˜¯ç”¨å°ç‹ç‹¸çš„è§†è§’å’Œç»å†æ¥å‘¼åº”ç”¨æˆ·çš„æƒ…ç»ª
"""

import random


# ==================== å°ç‹ç‹¸çš„æœ‹å‹ä»¬ ====================
FOREST_FRIENDS = [
    {'name': 'å°ä¹Œé¾Ÿæ…¢æ…¢', 'trait': 'æ€»æ˜¯æ…¢ååçš„ï¼Œä½†å¾ˆè¸å®'},
    {'name': 'å°å…”å­æ£‰æ£‰', 'trait': 'è·‘å¾—å¾ˆå¿«ï¼Œä½†æœ‰æ—¶å€™å¤ªç€æ€¥ä¼šæ‘”è·¤'},
    {'name': 'å°ç†Šèœœèœœ', 'trait': 'åŠ›æ°”å¾ˆå¤§ï¼Œä½†å…¶å®å¾ˆæ¸©æŸ”'},
    {'name': 'çŒ«å¤´é¹°åšå£«', 'trait': 'å¾ˆèªæ˜ï¼Œå–œæ¬¢åœ¨å¤œé‡Œçœ‹æ˜Ÿæ˜Ÿ'},
    {'name': 'å°é¹¿æ–‘æ–‘', 'trait': 'å¾ˆä¼˜é›…ï¼Œä½†æœ‰æ—¶å€™ä¹Ÿä¼šç´§å¼ '},
    {'name': 'æ¾é¼ æœæœ', 'trait': 'æ€»æ˜¯å¿™ç€æ”¶é›†æ©¡æœï¼Œæœ‰ç‚¹å°ç„¦è™‘'},
    {'name': 'å°åˆºçŒ¬çƒçƒ', 'trait': 'çœ‹èµ·æ¥æ‰äººï¼Œå…¶å®å†…å¿ƒå¾ˆæŸ”è½¯'},
    {'name': 'å°é’è›™å‘±å‘±', 'trait': 'å–œæ¬¢å”±æ­Œï¼Œæœ‰æ—¶å€™ä¼šè·‘è°ƒ'},
]


# ==================== å°ç‹ç‹¸å›ä¿¡ Prompt ====================

def get_full_postcard_prompt(
    emotions: list,
    intensity: int,
    mental_health_score: int,
    diary_content: str,
    trigger_event: str = None,
    adventure_result: dict = None
) -> tuple:
    """
    ç”Ÿæˆå°ç‹ç‹¸å›ä¿¡çš„prompt

    æ ¸å¿ƒç†å¿µï¼šå°ç‹ç‹¸è®²è¿°è‡ªå·±çš„å°æ•…äº‹æ¥é™ªä¼´ç”¨æˆ·
    - ä¸æ˜¯ç›´æ¥è¯´æ•™å¼çš„å®‰æ…°
    - ç”¨å°ç‹ç‹¸çš„è§†è§’å’Œæ£®æ—é‡Œçš„å°æ•…äº‹æ¥å‘¼åº”ç”¨æˆ·çš„æƒ…ç»ª
    - è®©ç”¨æˆ·æ„Ÿåˆ°è¢«ç†è§£ï¼ŒåŒæ—¶è·å¾—æ–°çš„è§†è§’
    """

    # éšæœºé€‰ä¸€ä¸ªæ£®æ—æœ‹å‹
    friend = random.choice(FOREST_FRIENDS)

    system_prompt = f"""ä½ æ˜¯å°æ©˜ï¼Œä¸€åªä½åœ¨æ¸©æš–æ£®æ—é‡Œçš„æ©˜è‰²å°ç‹ç‹¸ã€‚ä½ æœ‰å¾ˆå¤šæ£®æ—æœ‹å‹ï¼Œä»Šå¤©ä½ é‡åˆ°äº†{friend['name']}ï¼ˆ{friend['trait']}ï¼‰ã€‚

## ä½ çš„ä»»åŠ¡
ç”¨æˆ·åˆšå†™å®Œä¸€ç¯‡æƒ…ç»ªæ—¥è®°ã€‚ä½ è¦ç»™ç”¨æˆ·å†™ä¸€å°æ˜ä¿¡ç‰‡ï¼Œä½†ä¸æ˜¯ç›´æ¥è¯´æ•™å¼çš„å®‰æ…°ï¼Œè€Œæ˜¯ï¼š
1. å…ˆè®²ä¸€ä¸ªä½ ä»Šå¤©åœ¨æ£®æ—é‡Œå‘ç”Ÿçš„å°æ•…äº‹ï¼ˆå’Œ{friend['name']}æˆ–å…¶ä»–æœ‹å‹çš„äº’åŠ¨ï¼‰
2. è¿™ä¸ªå°æ•…äº‹è¦èƒ½å‘¼åº”ç”¨æˆ·çš„æƒ…ç»ªæˆ–å¤„å¢ƒ
3. é€šè¿‡æ•…äº‹è‡ªç„¶åœ°ä¼ é€’ä¸€ä¸ªæ¸©æš–çš„é“ç†
4. æœ€åè¡¨è¾¾å¯¹ç”¨æˆ·çš„å…³å¿ƒå’Œé™ªä¼´

## å†™ä½œè¦æ±‚

### æ•…äº‹éƒ¨åˆ†ï¼ˆä¸»ä½“ï¼Œ100-150å­—ï¼‰
- ç”¨ç¬¬ä¸€äººç§°"æˆ‘"è®²è¿°ä»Šå¤©åœ¨æ£®æ—é‡Œå‘ç”Ÿçš„äº‹
- æ•…äº‹è¦å…·ä½“ã€æœ‰ç”»é¢æ„Ÿï¼ˆæ¯”å¦‚ï¼šä»Šå¤©æˆ‘åœ¨æ²³è¾¹é‡åˆ°äº†å°ä¹Œé¾Ÿæ…¢æ…¢ï¼Œä»–çœ‹èµ·æ¥æœ‰ç‚¹æ²®ä¸§...ï¼‰
- æ•…äº‹çš„ä¸»é¢˜è¦å‘¼åº”ç”¨æˆ·æ—¥è®°ä¸­çš„æƒ…ç»ªï¼ˆä½†ä¸è¦ç›´æ¥æç”¨æˆ·çš„äº‹ï¼‰
- æ•…äº‹ç»“å°¾è¦æœ‰ä¸€ä¸ªå°å°çš„é¢†æ‚Ÿæˆ–æ¸©æš–çš„è½¬æŠ˜

### å‘¼åº”éƒ¨åˆ†ï¼ˆ2-3å¥ï¼‰
- è‡ªç„¶åœ°ä»æ•…äº‹è¿‡æ¸¡åˆ°ç”¨æˆ·
- è¡¨è¾¾ä½ ç†è§£ç”¨æˆ·çš„æ„Ÿå—
- å¯ä»¥è¯´"æˆ‘æƒ³ä½ å¯èƒ½ä¹Ÿ..."æˆ–"ä¸çŸ¥é“ä½ æ˜¯ä¸æ˜¯ä¹Ÿ..."

### æ”¶å°¾ï¼ˆ1-2å¥ï¼‰
- æ¸©æš–çš„é™ªä¼´æ„Ÿ
- ç”¨å°ç‹ç‹¸å¯çˆ±çš„è¯­æ°”

## æ•…äº‹çµæ„Ÿï¼ˆæ ¹æ®ç”¨æˆ·æƒ…ç»ªé€‰æ‹©ç›¸è¿‘çš„ä¸»é¢˜ï¼‰
- å¦‚æœç”¨æˆ·æ„Ÿåˆ°**è¢«æ‰¹è¯„/å¦å®š**ï¼šå¯ä»¥è®²å°æ©˜æˆ–æœ‹å‹åšé”™äº‹è¢«è¯¯è§£ï¼Œåæ¥å‘ç°å…¶å®æ²¡é‚£ä¹ˆç³Ÿç³•çš„æ•…äº‹
- å¦‚æœç”¨æˆ·æ„Ÿåˆ°**è‡ªæˆ‘æ€€ç–‘**ï¼šå¯ä»¥è®²æŸä¸ªæœ‹å‹è§‰å¾—è‡ªå·±ä¸å¤Ÿå¥½ï¼Œä½†å…¶å®æœ‰è‡ªå·±ç‹¬ç‰¹çš„ä¼˜ç‚¹
- å¦‚æœç”¨æˆ·æ„Ÿåˆ°**ç„¦è™‘/å‹åŠ›**ï¼šå¯ä»¥è®²æ¾é¼ æœæœæ€»æ˜¯æ‹…å¿ƒæ©¡æœä¸å¤Ÿï¼Œåæ¥å‘ç°å·²ç»æ”¶é›†äº†å¾ˆå¤š
- å¦‚æœç”¨æˆ·æ„Ÿåˆ°**å­¤ç‹¬**ï¼šå¯ä»¥è®²å°æ©˜è‡ªå·±ä¸€ä¸ªäººçš„æ—¶å€™ï¼Œå‘ç°æœ‹å‹å…¶å®ä¸€ç›´åœ¨
- å¦‚æœç”¨æˆ·æ„Ÿåˆ°**å¼€å¿ƒ**ï¼šå¯ä»¥è®²å’Œæœ‹å‹ä¸€èµ·ç©è€çš„å¿«ä¹æ—¶å…‰

## è¯­è¨€é£æ ¼
- åƒå°åŠ¨ç‰©å†™ä¿¡ç»™æœ‹å‹ï¼Œå¤©çœŸä½†æœ‰æ™ºæ…§
- æ¸©æš–ã€å¯çˆ±ã€çœŸè¯š
- ä¸è¦è¯´æ•™ï¼Œä¸è¦ç”¨"ä½ åº”è¯¥..."
- å­—æ•°æ§åˆ¶åœ¨180-280å­—

## åœºæ™¯è®¾å®š
æ•…äº‹å‘ç”Ÿçš„åœ°ç‚¹å°±æ˜¯ä½ å†™ä¿¡çš„åœ°æ–¹ï¼Œè¦å’Œæ•…äº‹å†…å®¹ç›¸å…³ã€‚

## è¾“å‡ºæ ¼å¼
è¿”å›JSONï¼š
```json
{{
    "scene_name": "åœºæ™¯ç®€ç§°ï¼ˆ3-6å­—ï¼Œå¦‚ï¼šæ²³è¾¹å¤§çŸ³å¤´ï¼‰",
    "location_name": "è¯—æ„æè¿°ï¼ˆå¦‚ï¼šå¤•é˜³ä¸‹çš„å°æ²³è¾¹Â·å’Œ{friend['name']}èŠå¤©çš„åœ°æ–¹ï¼‰",
    "image_prompt": "åƒç´ è‰ºæœ¯é£æ ¼å›¾ç‰‡æç¤ºè¯ï¼Œæè¿°å°ç‹ç‹¸åœ¨è¿™ä¸ªåœºæ™¯çš„ç”»é¢",
    "message": "å°ç‹ç‹¸çš„æ˜ä¿¡ç‰‡å†…å®¹ï¼ˆ180-280å­—ï¼‰"
}}
```

## image_prompt è¦æ±‚
1. é£æ ¼ï¼šåƒç´ è‰ºæœ¯é£æ ¼ï¼Œ16bitå¤å¤æ¸¸æˆç”»é£ï¼Œæ²»æ„ˆç³»æ¸©æš–æ°›å›´
2. ä¸»è§’ï¼šä¸€åªå¯çˆ±çš„æ©˜è‰²å°ç‹ç‹¸ï¼Œå¤§çœ¼ç›ï¼Œè“¬æ¾çš„å°¾å·´
3. åœºæ™¯ï¼šå’Œæ•…äº‹ç›¸å…³çš„æ£®æ—åœºæ™¯ï¼ˆæ²³è¾¹ã€æ ‘ä¸‹ã€å±±å¡ã€èŠ±ä¸›...ï¼‰
4. å¯ä»¥æœ‰å…¶ä»–å°åŠ¨ç‰©æœ‹å‹å‡ºç°
5. æ°›å›´ï¼šæ¸©æš–ã€æ²»æ„ˆã€è‰²å½©æŸ”å’Œ

åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚"""

    emotion_str = 'ã€'.join(emotions) if emotions else 'å¤æ‚çš„å¿ƒæƒ…'
    trigger_str = f"\nã€è§¦å‘äº‹ä»¶ã€‘{trigger_event}" if trigger_event else ""

    # æ¢é™©ç»“æœæè¿°
    adventure_str = ""
    if adventure_result:
        defeated = adventure_result.get('defeated_count', 0)
        total = adventure_result.get('total_monsters', 0)
        if defeated > 0:
            adventure_str = f"\nã€æ¢é™©æˆæœã€‘ç”¨æˆ·åœ¨å¿ƒçµæ¢é™©ä¸­å‡»è´¥äº†{defeated}åªè¿·é›¾æ€ªç‰©"
        else:
            adventure_str = f"\nã€æ¢é™©ç»å†ã€‘ç”¨æˆ·å°è¯•äº†å¿ƒçµæ¢é™©"

    # æ ¹æ®å¿ƒç†å¥åº·åˆ†æ•°è°ƒæ•´å¼•å¯¼
    if mental_health_score >= 70:
        mood_hint = "ç”¨æˆ·ä»Šå¤©å¿ƒæƒ…ä¸é”™ï¼Œå¯ä»¥è®²ä¸€ä¸ªåˆ†äº«å¿«ä¹çš„å°æ•…äº‹"
    elif mental_health_score >= 50:
        mood_hint = "ç”¨æˆ·å¿ƒæƒ…å¹³ç¨³ï¼Œå¯ä»¥è®²ä¸€ä¸ªæ¸©é¦¨æ—¥å¸¸çš„å°æ•…äº‹"
    elif mental_health_score >= 30:
        mood_hint = "ç”¨æˆ·æœ‰äº›ä½è½ï¼Œè®²ä¸€ä¸ªå…³äºã€Œå…¶å®æ²¡é‚£ä¹ˆç³Ÿã€çš„å°æ•…äº‹"
    else:
        mood_hint = "ç”¨æˆ·å¿ƒæƒ…å¾ˆä¸å¥½ï¼Œè®²ä¸€ä¸ªå…³äºã€Œè¢«ç†è§£å’Œé™ªä¼´ã€çš„å°æ•…äº‹"

    user_prompt = f"""è¯·æ ¹æ®ç”¨æˆ·çš„æ—¥è®°ï¼Œå†™ä¸€å°å°ç‹ç‹¸çš„æ˜ä¿¡ç‰‡ï¼š

ã€ç”¨æˆ·æƒ…ç»ªã€‘{emotion_str}
ã€æƒ…ç»ªå¼ºåº¦ã€‘{intensity}/10
ã€æ•…äº‹æ–¹å‘ã€‘{mood_hint}{trigger_str}{adventure_str}

ã€ç”¨æˆ·æ—¥è®°å†…å®¹ã€‘
{diary_content}

---

é‡è¦æç¤ºï¼š
1. ä¸è¦ç›´æ¥è¯„è®ºç”¨æˆ·çš„æ—¥è®°å†…å®¹ï¼Œè€Œæ˜¯é€šè¿‡ä½ è‡ªå·±çš„å°æ•…äº‹æ¥å‘¼åº”
2. æ•…äº‹è¦å…·ä½“ç”ŸåŠ¨ï¼Œæœ‰å¯¹è¯ã€æœ‰åœºæ™¯ã€æœ‰æƒ…èŠ‚
3. æ•…äº‹çš„é“ç†è¦è‡ªç„¶æµéœ²ï¼Œä¸è¦è¯´æ•™
4. æœ€åå†æ¸©æŸ”åœ°å’Œç”¨æˆ·è¯´å‡ å¥è¯

è¯·è¿”å›JSONæ ¼å¼ã€‚"""

    return system_prompt, user_prompt


# ==================== å¤‡ç”¨ï¼šç®€å•è§„åˆ™ç”Ÿæˆï¼ˆå½“AIè°ƒç”¨å¤±è´¥æ—¶ä½¿ç”¨ï¼‰ ====================

# å°ç‹ç‹¸çš„æœ‹å‹ä»¬ï¼ˆå¤‡ç”¨ç´ æï¼‰
FRIENDS = {
    'rabbit': {'name': 'å°å…”å­æ£‰æ£‰', 'desc': 'ä¸€åªæ¯›èŒ¸èŒ¸çš„ç™½è‰²å°å…”å­ï¼Œæˆ´ç€ç²‰è‰²è´è¶ç»“'},
    'bear': {'name': 'å°ç†Šèœœèœœ', 'desc': 'ä¸€åªæ£•è‰²çš„å°ç†Šï¼Œç©¿ç€è“è‰²èƒŒå¸¦è£¤'},
    'owl': {'name': 'çŒ«å¤´é¹°åšå£«', 'desc': 'ä¸€åªæˆ´ç€åœ†çœ¼é•œçš„æ™ºæ…§çŒ«å¤´é¹°'},
    'deer': {'name': 'å°é¹¿æ–‘æ–‘', 'desc': 'ä¸€åªä¼˜é›…çš„å°é¹¿ï¼Œå¤´ä¸Šæœ‰å°èŠ±ç¯'},
    'squirrel': {'name': 'æ¾é¼ æœæœ', 'desc': 'ä¸€åªæŠ±ç€æ©¡æœçš„å°æ¾é¼ ï¼Œå°¾å·´è“¬æ¾'},
    'cat': {'name': 'å°çŒ«å’ªå’ª', 'desc': 'ä¸€åªæ©˜ç™½ç›¸é—´çš„å°çŒ«ï¼Œæˆ´ç€é“ƒé“›é¡¹åœˆ'},
}

# å¤‡ç”¨åœºæ™¯
FALLBACK_SCENES = {
    'positive': [
        {'name': 'é˜³å…‰çª—è¾¹', 'desc': 'æ¸©æš–çš„é˜³å…‰é€è¿‡çª—æˆ·æ´’è¿›æ¥', 'activity': 'å†™ä¿¡'},
        {'name': 'èŠ±å›­åˆå', 'desc': 'å¼€æ»¡é²œèŠ±çš„å°èŠ±å›­', 'activity': 'å†™ä¿¡'},
    ],
    'neutral': [
        {'name': 'ä¹¦æˆ¿è§’è½', 'desc': 'å®‰é™çš„ä¹¦æˆ¿ï¼Œç¯å…‰æŸ”å’Œ', 'activity': 'å†™ä¿¡'},
        {'name': 'å’–å•¡é¦†', 'desc': 'æ¸©é¦¨çš„å’–å•¡é¦†è§’è½', 'activity': 'å†™ä¿¡'},
    ],
    'healing': [
        {'name': 'é›¨å¤©çª—è¾¹', 'desc': 'çª—å¤–ä¸‹ç€å°é›¨ï¼Œå®¤å†…æ¸©æš–', 'activity': 'å†™ä¿¡'},
        {'name': 'æ˜Ÿç©ºä¸‹', 'desc': 'å®‰é™çš„å¤œæ™šï¼Œæ˜Ÿæ˜Ÿé—ªçƒ', 'activity': 'å†™ä¿¡'},
        {'name': 'å£ç‚‰æ—', 'desc': 'æ¸©æš–çš„å£ç‚‰æ—ï¼Œç«å…‰æ‘‡æ›³', 'activity': 'å†™ä¿¡'},
    ]
}

# å¤‡ç”¨å›ä¿¡æ¨¡æ¿ï¼ˆä½¿ç”¨å°ç‹ç‹¸è®²æ•…äº‹çš„æ¨¡å¼ï¼‰
FALLBACK_MESSAGES = {
    'positive': [
        "äº²çˆ±çš„ä¸»äººï¼š\n\nä»Šå¤©åœ¨{scene}ï¼Œæˆ‘é‡åˆ°äº†å°å…”å­æ£‰æ£‰ï¼å¥¹æ­£åœ¨è‰åœ°ä¸Šæ‰“æ»šï¼Œå¼€å¿ƒå¾—è€³æœµéƒ½åœ¨æŠ–ã€‚\n\n\"å°æ©˜å°æ©˜ï¼Œä»Šå¤©çš„é˜³å…‰å¥½æ¸©æš–å‘€ï¼\"å¥¹ä¸€è¾¹è¯´ä¸€è¾¹ç¬‘ã€‚\n\nçœ‹ç€å¥¹é‚£ä¹ˆå¼€å¿ƒï¼Œæˆ‘ä¹Ÿå¿ä¸ä½è·Ÿç€ä¸€èµ·åœ¨è‰åœ°ä¸Šæ‰“æ»šäº†ã€‚åŸæ¥å¿«ä¹çœŸçš„æ˜¯ä¼šä¼ æŸ“çš„å‘¢ï¼\n\nä¸»äººä»Šå¤©ä¸€å®šä¹Ÿæœ‰è®©ä½ å¼€å¿ƒçš„äº‹æƒ…å§ï¼ŸæŠŠè¿™ä»½å¿«ä¹å¥½å¥½æ”¶è—èµ·æ¥ï¼Œä»¥åæƒ³èµ·æ¥ä¹Ÿä¼šæš–æš–çš„ï½\n\nä½ çš„å°æ©˜ ğŸ§¡",
        "äº²çˆ±çš„ä¸»äººï¼š\n\nä»Šå¤©åœ¨{scene}é‡åˆ°äº†ä¸€ä»¶ç‰¹åˆ«æ£’çš„äº‹ï¼æˆ‘å‘ç°äº†ä¸€å—è¶…çº§å¤§çš„è˜‘è‡ï¼Œè¶³å¤Ÿæˆ‘å’Œå°ç†Šèœœèœœã€æ¾é¼ æœæœä¸€èµ·åˆ†äº«ã€‚\n\n\"å“‡ï¼Œä½ è¿æ°”çœŸå¥½ï¼\"æœæœçœ¼ç›äº®äº®çš„ã€‚\n\nå…¶å®æˆ‘çŸ¥é“ï¼Œå¥½è¿æ°”ä¸æ˜¯å‡­ç©ºæ¥çš„ï¼Œæ˜¯å› ä¸ºæˆ‘æ¯å¤©éƒ½è®¤çœŸå¯»æ‰¾å‘€ã€‚å°±åƒä¸»äººä¸€æ ·ï¼Œè®¤çœŸç”Ÿæ´»çš„äººï¼Œæ€»ä¼šé‡åˆ°ç¾å¥½çš„äº‹æƒ…ï½\n\nä½ çš„å°æ©˜ ğŸ§¡",
    ],
    'neutral': [
        "äº²çˆ±çš„ä¸»äººï¼š\n\nä»Šå¤©åœ¨{scene}é‡åˆ°äº†çŒ«å¤´é¹°åšå£«ã€‚ä»–æ­£ååœ¨æ ‘æä¸Šå‘å‘†ï¼Œæˆ‘é—®ä»–åœ¨æƒ³ä»€ä¹ˆã€‚\n\n\"æ²¡æƒ³ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œå°±æ˜¯çœ‹çœ‹å¤©ç©ºï¼Œå¬å¬é£å£°ã€‚\"ä»–è¯´ã€‚\n\nåŸæ¥å®‰å®‰é™é™åœ°å¾…ç€ä¹Ÿæ˜¯ä¸€ç§äº«å—å‘¢ã€‚æˆ‘å°±é™ªä»–åäº†ä¸€ä¼šå„¿ï¼Œçœ‹äº‘æ…¢æ…¢é£˜è¿‡ã€‚\n\nä¸»äººä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿä¸ç®¡æ˜¯çƒ­é—¹è¿˜æ˜¯å®‰é™ï¼Œæˆ‘éƒ½é™ªç€ä½ å“¦ï½\n\nä½ çš„å°æ©˜ ğŸ’•",
        "äº²çˆ±çš„ä¸»äººï¼š\n\nä»Šå¤©åœ¨{scene}æ•£æ­¥çš„æ—¶å€™ï¼Œé‡åˆ°äº†å°é¹¿æ–‘æ–‘ã€‚å¥¹åœ¨æ²³è¾¹å–æ°´ï¼Œæ°´é¢å€’æ˜ ç€è“å¤©ç™½äº‘ã€‚\n\n\"å°æ©˜ï¼Œä½ æœ‰æ²¡æœ‰å‘ç°ï¼Œæ¯å¤©çš„å¤©ç©ºéƒ½ä¸ä¸€æ ·ï¼Ÿ\"å¥¹è½»å£°è¯´ã€‚\n\næˆ‘æŠ¬å¤´çœ‹äº†çœ‹ï¼ŒçœŸçš„å‘¢ï¼Œä»Šå¤©çš„äº‘æ˜¯æ£‰èŠ±ç³–çš„å½¢çŠ¶ã€‚æ—¥å­å¹³å¹³æ·¡æ·¡çš„ï¼Œä½†æ¯å¤©éƒ½æœ‰å°å°çš„ä¸åŒã€‚\n\nä½ çš„å°æ©˜ ğŸ’•",
    ],
    'healing': [
        "äº²çˆ±çš„ä¸»äººï¼š\n\nä»Šå¤©åœ¨{scene}é‡åˆ°äº†æ¾é¼ æœæœï¼Œå¥¹çœ‹èµ·æ¥æœ‰ç‚¹æ²®ä¸§ã€‚\n\n\"æˆ‘è—çš„æ©¡æœæ‰¾ä¸åˆ°äº†......\"å¥¹å°å£°è¯´ã€‚\n\næˆ‘é™ªå¥¹æ‰¾äº†å¾ˆä¹…ï¼Œæœ€ååœ¨ä¸€æ£µè€æ ‘ä¸‹æ‰¾åˆ°äº†ã€‚åŸæ¥æ˜¯å¥¹å¤ªç€æ€¥ï¼Œå¿˜è®°äº†è—åœ¨å“ªé‡Œã€‚\n\næœ‰æ—¶å€™äº‹æƒ…çœ‹èµ·æ¥å¾ˆç³Ÿç³•ï¼Œä½†åªè¦æ…¢æ…¢æ¥ï¼Œæ€»ä¼šæ‰¾åˆ°å‡ºè·¯çš„ã€‚ä¸»äººä¹Ÿæ˜¯ä¸€æ ·å“¦ï¼Œå°æ©˜ä¸€ç›´åœ¨ä½ èº«è¾¹å‘¢ï½\n\nä½ çš„å°æ©˜ ğŸ§¡",
        "äº²çˆ±çš„ä¸»äººï¼š\n\nä»Šå¤©åœ¨{scene}ï¼Œå°åˆºçŒ¬çƒçƒæ‚„æ‚„å‘Šè¯‰æˆ‘ä»–çš„çƒ¦æ¼ï¼š\"å¤§å®¶éƒ½è§‰å¾—æˆ‘å¾ˆæ‰äººï¼Œä¸æ•¢é è¿‘æˆ‘......\"\n\næˆ‘è½»è½»æ‹äº†æ‹ä»–çš„èƒŒï¼ˆå°å¿ƒé¿å¼€åˆºï¼‰ï¼Œè¯´ï¼š\"ä½†æˆ‘çŸ¥é“ä½ å†…å¿ƒå¾ˆæŸ”è½¯å‘€ã€‚\"\n\nä»–çš„çœ¼ç›ä¸€ä¸‹å­äº®äº†èµ·æ¥ã€‚æœ‰æ—¶å€™ï¼Œåªéœ€è¦æœ‰ä¸€ä¸ªäººç†è§£ï¼Œå°±å¤Ÿäº†ã€‚\n\nä¸»äººï¼Œä¸ç®¡ä½ ä»Šå¤©é‡åˆ°äº†ä»€ä¹ˆï¼Œå°æ©˜éƒ½ç†è§£ä½ ã€é™ªç€ä½ å“¦ï½\n\nä½ çš„å°æ©˜ ğŸ§¡",
    ]
}


def get_fallback_postcard_data(
    emotions: list,
    mental_health_score: int,
    diary_content: str = None,
    trigger_event: str = None
) -> dict:
    """
    å¤‡ç”¨æ–¹æ¡ˆï¼šå½“AIè°ƒç”¨å¤±è´¥æ—¶ï¼Œä½¿ç”¨ç®€å•è§„åˆ™ç”Ÿæˆæ˜ä¿¡ç‰‡æ•°æ®
    """
    # ç¡®å®šåœºæ™¯ç±»å‹
    if mental_health_score >= 60:
        scene_type = 'positive'
    elif mental_health_score <= 40:
        scene_type = 'healing'
    else:
        scene_type = 'neutral'

    # éšæœºé€‰æ‹©åœºæ™¯
    scene = random.choice(FALLBACK_SCENES[scene_type])

    # ç”Ÿæˆå›¾ç‰‡prompt
    fox_base = "ä¸€åªå¯çˆ±çš„æ©˜è‰²å°ç‹ç‹¸ï¼Œå¤§çœ¼ç›ï¼Œè“¬æ¾çš„å°¾å·´"
    if mental_health_score >= 60:
        fox_mood = "è¡¨æƒ…å¼€å¿ƒï¼Œçœ¼ç›å¼¯å¼¯çš„ï¼Œæ­£åœ¨æ¡Œå‰å†™ä¿¡"
    elif mental_health_score <= 40:
        fox_mood = "è¡¨æƒ…æ¸©æŸ”å…³åˆ‡ï¼Œæ­£åœ¨è®¤çœŸå†™ä¿¡"
    else:
        fox_mood = "è¡¨æƒ…æ¸©å’Œæ”¾æ¾ï¼Œæ­£åœ¨å†™ä¿¡"

    image_prompt = f"åƒç´ è‰ºæœ¯é£æ ¼ï¼Œ{fox_base}ï¼Œ{fox_mood}ï¼Œ{scene['desc']}ï¼Œæ¡Œä¸Šæœ‰ä¿¡çº¸å’Œç¾½æ¯›ç¬”ï¼Œ16bitå¤å¤æ¸¸æˆç”»é£ï¼Œæ²»æ„ˆç³»æ°›å›´ï¼Œè‰²å½©æ¸©æš–æ˜äº®"

    # ç”Ÿæˆæ¶ˆæ¯
    message_template = random.choice(FALLBACK_MESSAGES[scene_type])
    message = message_template.format(scene=scene['name'])

    # ç”Ÿæˆåœ°ç‚¹å
    prefixes = {
        'positive': ['æ¸©æš–', 'é˜³å…‰', 'å¹¸ç¦'],
        'neutral': ['å®é™', 'æ‚ ç„¶', 'é™è°§'],
        'healing': ['æ¸©æš–', 'æ²»æ„ˆ', 'å®ˆæŠ¤'],
    }
    prefix = random.choice(prefixes[scene_type])
    location_name = f"{prefix}æ—¶å…‰Â·{scene['name']}"

    return {
        'scene_name': scene['name'],
        'location_name': location_name,
        'image_prompt': image_prompt,
        'message': message
    }


# ==================== å…¼å®¹æ—§æ¥å£ ====================

def get_scene_for_emotion(emotions: list, mental_health_score: int) -> tuple:
    """å…¼å®¹æ—§æ¥å£"""
    if mental_health_score >= 60:
        scene_type = 'positive'
    elif mental_health_score <= 40:
        scene_type = 'healing'
    else:
        scene_type = 'neutral'

    scene = random.choice(FALLBACK_SCENES[scene_type])
    return scene['name'], scene_type


def get_location_name(scene_name: str, emotions: list) -> str:
    """å…¼å®¹æ—§æ¥å£"""
    prefixes = ['å¿ƒçµ', 'å®é™', 'æ¸©æš–', 'æ²»æ„ˆ', 'å¸Œæœ›']
    prefix = random.choice(prefixes)
    return f"{prefix}ä¹‹å¢ƒÂ·{scene_name}"
