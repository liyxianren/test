<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†™æ—¥è®° - CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆ</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        /* é¡µé¢ä¸“å±æ ·å¼ä¼˜åŒ– */
        .diary-new-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ - æ‰©å±•åˆ°æ›´å®½ */
        .main-diary-area {
            padding-right: 2rem;
        }

        /* AIåŠ©æ‰‹ä¾§è¾¹æ  - äºŒæ¬¡å…ƒæ¸¸æˆé£æ ¼ */
        .ai-sidebar-fixed {
            position: sticky;
            top: 100px;
            height: calc(100vh - 120px);
            overflow-y: auto;
            padding-left: 1rem;
        }

        /* AIæ¬¢è¿å¡ç‰‡ - å¯çˆ±æ¸å˜é£æ ¼ */
        .ai-welcome-card {
            background: linear-gradient(135deg, #FFB6C1 0%, #89F0E7 50%, #D4BBFF 100%);
            border-radius: 30px;
            padding: 2rem;
            color: white;
            margin-bottom: 1.5rem;
            box-shadow: 0 15px 35px rgba(78, 205, 196, 0.25);
            position: relative;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.5);
        }

        /* å¯çˆ±çš„æ˜Ÿæ˜Ÿè£…é¥° */
        .ai-welcome-card::before {
            content: 'âœ¨';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 2rem;
            animation: twinkle 2s ease-in-out infinite;
        }

        .ai-welcome-card::after {
            content: 'ğŸ’«';
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 1.5rem;
            animation: twinkle 2s ease-in-out infinite 1s;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .ai-welcome-card h4 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            font-family: 'Fredoka', sans-serif;
        }

        .ai-welcome-card .ai-avatar-large {
            font-size: 3.5rem;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 5px 15px rgba(255, 255, 255, 0.5));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }

        .ai-welcome-card p {
            opacity: 0.95;
            margin: 0;
            font-size: 0.95rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            line-height: 1.6;
        }

        /* æç¤ºå¡ç‰‡ - å¯çˆ±æ¸å˜è¾¹æ¡† */
        .ai-tips-card {
            background: white;
            border-radius: 24px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 20px rgba(255, 107, 157, 0.15);
            border: 3px solid transparent;
            background-image:
                linear-gradient(white, white),
                linear-gradient(135deg, #FFB6C1 0%, #89F0E7 50%, #D4BBFF 100%);
            background-origin: border-box;
            background-clip: padding-box, border-box;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
        }

        .ai-tips-card:hover {
            box-shadow: 0 15px 35px rgba(78, 205, 196, 0.25);
            transform: translateY(-5px) scale(1.02);
        }

        /* å¡ç‰‡æ ‡é¢˜æ¸å˜æ•ˆæœ */
        .ai-tips-card h5 {
            background: linear-gradient(135deg, #FF6B9D 0%, #FFC107 50%, #FF9800 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.2rem;
            font-weight: 800;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Fredoka', sans-serif;
        }

        .ai-tips-card h5 i {
            background: linear-gradient(135deg, #FF6B9D 0%, #FFC107 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.3rem;
        }

        /* æç¤ºé¡¹ - å¯çˆ±æ°”æ³¡é£æ ¼ */
        .ai-tip-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.1) 0%, rgba(137, 240, 231, 0.1) 100%);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid transparent;
            position: relative;
        }

        .ai-tip-item:last-child {
            margin-bottom: 0;
        }

        .ai-tip-item:hover {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.2) 0%, rgba(137, 240, 231, 0.2) 100%);
            transform: translateX(8px) scale(1.02);
            border-color: rgba(255, 107, 157, 0.3);
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.15);
        }

        .ai-tip-icon {
            font-size: 1.8rem;
            flex-shrink: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .ai-tip-text {
            font-size: 0.95rem;
            color: #4a5568;
            line-height: 1.7;
        }

        .ai-tip-text strong {
            background: linear-gradient(135deg, #FF6B9D 0%, #A78BFA 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        /* è¿›åº¦æŒ‡ç¤ºä¼˜åŒ– */
        .stepper-progress {
            background: white;
            border-radius: 24px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 20px rgba(255, 107, 157, 0.15);
            border: 3px solid transparent;
            background-image:
                linear-gradient(white, white),
                linear-gradient(135deg, #FFB6C1 0%, #89F0E7 50%, #D4BBFF 100%);
            background-origin: border-box;
            background-clip: padding-box, border-box;
        }

        /* æ­¥éª¤å¡ç‰‡ä¼˜åŒ– */
        .step-card {
            background: white;
            border-radius: 30px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 20px rgba(255, 107, 157, 0.15);
            border: 3px solid #f0f0f0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .step-card.active {
            border: 3px solid transparent;
            background-image:
                linear-gradient(white, white),
                linear-gradient(135deg, #FFB6C1 0%, #89F0E7 50%, #D4BBFF 100%);
            background-origin: border-box;
            background-clip: padding-box, border-box;
            box-shadow: 0 15px 35px rgba(78, 205, 196, 0.25);
            transform: scale(1.01);
        }

        /* æƒ…ç»ªç½‘æ ¼ä¼˜åŒ– */
        .emotion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .emotion-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* AIåˆ†æç»“æœå¡ç‰‡ */
        .ai-analysis-result {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            animation: slideInRight 0.5s ease-out;
            border: 3px solid rgba(255, 255, 255, 0.5);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .game-values-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .game-value-item {
            background: white;
            border-radius: 16px;
            padding: 1rem;
            text-align: center;
            border: 2px solid rgba(255, 182, 193, 0.3);
        }

        .game-value-number {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #FF6B9D 0%, #A78BFA 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: block;
        }

        .game-value-label {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 0.25rem;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 991px) {
            .ai-sidebar-fixed {
                position: static;
                height: auto;
                padding-left: 0;
                margin-top: 2rem;
            }

            .main-diary-area {
                padding-right: 0;
            }
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– - æ¸å˜è‰² */
        .ai-sidebar-fixed::-webkit-scrollbar {
            width: 8px;
        }

        .ai-sidebar-fixed::-webkit-scrollbar-track {
            background: rgba(255, 182, 193, 0.1);
            border-radius: 10px;
        }

        .ai-sidebar-fixed::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #FFB6C1 0%, #89F0E7 50%, #D4BBFF 100%);
            border-radius: 10px;
        }

        .ai-sidebar-fixed::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #FF6B9D 0%, #4ECDC4 50%, #A78BFA 100%);
        }

        /* å½“å‰æ­¥éª¤æç¤º - æ›´å¯çˆ±çš„é£æ ¼ */
        .current-step-hint {
            background: linear-gradient(135deg, #FFE082 0%, #FFC107 100%);
            border-radius: 20px;
            padding: 1.2rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: gentlePulse 2s ease-in-out infinite;
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        /* é—ªå…‰æ•ˆæœ */
        .current-step-hint::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes gentlePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3); }
            50% { transform: scale(1.03); box-shadow: 0 12px 30px rgba(255, 193, 7, 0.4); }
        }

        .current-step-hint .hint-icon {
            font-size: 2.2rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            z-index: 1;
        }

        .current-step-hint .hint-text {
            font-size: 1.05rem;
            font-weight: 700;
            color: #2d3748;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
            font-family: 'Fredoka', sans-serif;
            z-index: 1;
        }

        /* CBTæ­¥éª¤æ•°å­—ç¾åŒ– */
        .ai-tip-item[class*="1ï¸âƒ£"],
        .ai-tip-item[class*="2ï¸âƒ£"],
        .ai-tip-item[class*="3ï¸âƒ£"],
        .ai-tip-item[class*="4ï¸âƒ£"] {
            position: relative;
        }

        .ai-tip-item[class*="1ï¸âƒ£"]::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #FF6B9D 0%, #FFC107 100%);
            border-radius: 10px;
        }

        /* æµå¼è¾“å‡ºå…‰æ ‡åŠ¨ç”» */
        .streaming-cursor {
            display: inline-block;
            color: #667eea;
            font-weight: bold;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* ç”¨æˆ·æ¶ˆæ¯æ¡†æ ·å¼ */
        .user-message-box {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.05) 0%, rgba(137, 240, 231, 0.05) 100%);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1rem;
            border: 2px solid rgba(255, 182, 193, 0.2);
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <span class="navbar-logo-emoji">ğŸ’–</span>
                CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/diary">æƒ…ç»ªæ—¥è®°</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/postcards">ğŸ¦Š æ˜ä¿¡ç‰‡</a>
                    </li>
                </ul>
                <div class="d-flex gap-2 align-items-center">
                    <div id="authUser" class="d-flex gap-2 align-items-center">
                        <div class="dropdown">
                            <button class="btn btn-outline dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="username">ç”¨æˆ·</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>ä¸ªäººèµ„æ–™</a></li>
                                <li><a class="dropdown-item" href="/settings"><i class="fas fa-cog me-2"></i>è®¾ç½®</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="javascript:void(0);" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>é€€å‡ºç™»å½•</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="container-fluid py-5">
        <div class="diary-new-container">
            <div class="row">
                <!-- å·¦ä¾§ï¼šæ­¥éª¤å¼æ—¥è®°ç¼–å†™åŒºåŸŸ (æ‰©å±•åˆ° 8 åˆ—) -->
                <div class="col-lg-8 main-diary-area">
                    <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
                    <div class="stepper-progress mb-4">
                        <div class="step-item active" data-step="1">
                            <div class="step-circle">1</div>
                            <div class="step-label">è¯†åˆ«æƒ…ç»ª</div>
                        </div>
                        <div class="step-line"></div>
                        <div class="step-item" data-step="2">
                            <div class="step-circle">2</div>
                            <div class="step-label">è§¦å‘äº‹ä»¶</div>
                        </div>
                        <div class="step-line"></div>
                        <div class="step-item" data-step="3">
                            <div class="step-circle">3</div>
                            <div class="step-label">æƒ…ç»ªå¼ºåº¦</div>
                        </div>
                        <div class="step-line"></div>
                        <div class="step-item" data-step="4">
                            <div class="step-circle">4</div>
                            <div class="step-label">å†™æ—¥è®°</div>
                        </div>
                    </div>

                    <!-- æ­¥éª¤1ï¼šæƒ…ç»ªé€‰æ‹© -->
                    <div class="step-card active" id="step1Card">
                        <div class="step-card-header">
                            <div class="character-avatar-small">ğŸ’­</div>
                            <h2 class="step-title">ä½ ç°åœ¨çš„æƒ…ç»ªæ˜¯ä»€ä¹ˆï¼Ÿ</h2>
                            <p class="step-subtitle">å¯ä»¥é€‰æ‹©å¤šä¸ªæƒ…ç»ªå“¦ âœ¨</p>
                        </div>
                        <div class="step-card-body">
                            <div class="emotion-grid">
                                <button class="emotion-btn-game" data-emotion="å¼€å¿ƒ" data-emoji="ğŸ˜Š">
                                    <span class="emotion-emoji">ğŸ˜Š</span>
                                    <span class="emotion-label">å¼€å¿ƒ</span>
                                </button>
                                <button class="emotion-btn-game" data-emotion="å¹³é™" data-emoji="ğŸ˜Œ">
                                    <span class="emotion-emoji">ğŸ˜Œ</span>
                                    <span class="emotion-label">å¹³é™</span>
                                </button>
                                <button class="emotion-btn-game" data-emotion="æ‚²ä¼¤" data-emoji="ğŸ˜¢">
                                    <span class="emotion-emoji">ğŸ˜¢</span>
                                    <span class="emotion-label">æ‚²ä¼¤</span>
                                </button>
                                <button class="emotion-btn-game" data-emotion="æ„¤æ€’" data-emoji="ğŸ˜¡">
                                    <span class="emotion-emoji">ğŸ˜¡</span>
                                    <span class="emotion-label">æ„¤æ€’</span>
                                </button>
                                <button class="emotion-btn-game" data-emotion="ç„¦è™‘" data-emoji="ğŸ˜°">
                                    <span class="emotion-emoji">ğŸ˜°</span>
                                    <span class="emotion-label">ç„¦è™‘</span>
                                </button>
                                <button class="emotion-btn-game" data-emotion="å®³æ€•" data-emoji="ğŸ˜¨">
                                    <span class="emotion-emoji">ğŸ˜¨</span>
                                    <span class="emotion-label">å®³æ€•</span>
                                </button>
                                <button class="emotion-btn-game" data-emotion="åŒæ¶" data-emoji="ğŸ˜–">
                                    <span class="emotion-emoji">ğŸ˜–</span>
                                    <span class="emotion-label">åŒæ¶</span>
                                </button>
                                <button class="emotion-btn-game" data-emotion="æƒŠè®¶" data-emoji="ğŸ˜²">
                                    <span class="emotion-emoji">ğŸ˜²</span>
                                    <span class="emotion-label">æƒŠè®¶</span>
                                </button>
                                <button class="emotion-btn-game" data-emotion="å…´å¥‹" data-emoji="ğŸ¤©">
                                    <span class="emotion-emoji">ğŸ¤©</span>
                                    <span class="emotion-label">å…´å¥‹</span>
                                </button>
                                <button class="emotion-btn-game" data-emotion="æ²®ä¸§" data-emoji="ğŸ˜”">
                                    <span class="emotion-emoji">ğŸ˜”</span>
                                    <span class="emotion-label">æ²®ä¸§</span>
                                </button>
                                <button class="emotion-btn-game" data-emotion="å­¤ç‹¬" data-emoji="ğŸ˜">
                                    <span class="emotion-emoji">ğŸ˜</span>
                                    <span class="emotion-label">å­¤ç‹¬</span>
                                </button>
                                <button class="emotion-btn-game" data-emotion="æ¸©æš–" data-emoji="ğŸ¤—">
                                    <span class="emotion-emoji">ğŸ¤—</span>
                                    <span class="emotion-label">æ¸©æš–</span>
                                </button>
                            </div>
                            <div class="selected-emotions-preview mt-4" id="selectedEmotionsPreview" style="display: none;">
                                <div class="preview-label">å·²é€‰æ‹©çš„æƒ…ç»ªï¼š</div>
                                <div class="preview-tags" id="selectedEmotionTags"></div>
                            </div>
                        </div>
                        <div class="step-card-footer">
                            <button class="btn btn-primary btn-lg" id="nextStep1" disabled>
                                ä¸‹ä¸€æ­¥
                                <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- æ­¥éª¤2ï¼šè§¦å‘äº‹ä»¶ -->
                    <div class="step-card" id="step2Card">
                        <div class="step-card-header">
                            <div class="character-avatar-small">ğŸŒŸ</div>
                            <h2 class="step-title">æ˜¯ä»€ä¹ˆå¼•å‘äº†è¿™ç§æƒ…ç»ªï¼Ÿ</h2>
                            <p class="step-subtitle">æè¿°è§¦å‘ä½ æƒ…ç»ªçš„äº‹ä»¶æˆ–æƒ³æ³•</p>
                        </div>
                        <div class="step-card-body">
                            <textarea
                                class="form-control step-textarea"
                                id="triggerEvent"
                                rows="6"
                                placeholder="ä¾‹å¦‚ï¼šä»Šå¤©æ•°å­¦è€ƒè¯•æ²¡è€ƒå¥½ï¼Œæˆ‘è§‰å¾—è‡ªå·±å¾ˆå¤±è´¥..."
                            ></textarea>
                            <div class="char-counter mt-2">
                                <span id="charCount">0</span> å­—
                            </div>
                            <div class="quick-templates mt-4">
                                <div class="template-label">ğŸ’¡ å¿«æ·é€‰æ‹©ï¼š</div>
                                <div class="template-buttons">
                                    <button class="btn btn-sm btn-template" data-template="å­¦ä¸šå‹åŠ›ï¼šä»Šå¤©çš„ä½œä¸šå¤ªå¤šäº†ï¼Œæˆ‘æ„Ÿè§‰å®Œæˆä¸äº†...">ğŸ“š å­¦ä¸šå‹åŠ›</button>
                                    <button class="btn btn-sm btn-template" data-template="äººé™…å…³ç³»ï¼šå’Œæœ‹å‹å‘ç”Ÿäº†ä¸€äº›çŸ›ç›¾...">ğŸ‘¥ äººé™…å…³ç³»</button>
                                    <button class="btn btn-sm btn-template" data-template="å®¶åº­é—®é¢˜ï¼šçˆ¶æ¯å¯¹æˆ‘çš„æœŸæœ›å¾ˆé«˜ï¼Œæˆ‘æ‹…å¿ƒè®©ä»–ä»¬å¤±æœ›...">ğŸ  å®¶åº­é—®é¢˜</button>
                                    <button class="btn btn-sm btn-template" data-template="è‡ªæˆ‘æ€€ç–‘ï¼šæˆ‘è§‰å¾—è‡ªå·±ä¸å¤Ÿå¥½...">ğŸ¤” è‡ªæˆ‘æ€€ç–‘</button>
                                </div>
                            </div>
                        </div>
                        <div class="step-card-footer">
                            <button class="btn btn-outline btn-lg" id="prevStep2">
                                <i class="fas fa-arrow-left me-2"></i>
                                ä¸Šä¸€æ­¥
                            </button>
                            <button class="btn btn-primary btn-lg" id="nextStep2">
                                ä¸‹ä¸€æ­¥
                                <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- æ­¥éª¤3ï¼šæƒ…ç»ªå¼ºåº¦ -->
                    <div class="step-card" id="step3Card">
                        <div class="step-card-header">
                            <div class="character-avatar-small">ğŸ’«</div>
                            <h2 class="step-title">ä½ çš„æ„Ÿå—æœ‰å¤šå¼ºçƒˆï¼Ÿ</h2>
                            <p class="step-subtitle">é€‰æ‹©æœ€ç¬¦åˆä½ æ„Ÿå—çš„å¼ºåº¦</p>
                        </div>
                        <div class="step-card-body">
                            <div class="emoji-intensity-slider">
                                <div class="intensity-labels mb-3">
                                    <span class="intensity-min">è½»å¾®</span>
                                    <span class="intensity-current" id="intensityLabel">ä¸­ç­‰</span>
                                    <span class="intensity-max">å¼ºçƒˆ</span>
                                </div>
                                <div class="emoji-track" id="emojiTrack">
                                    <div class="emoji-progress" id="emojiProgress"></div>
                                    <button class="emoji-selector" data-intensity="1" data-label="éå¸¸è½»å¾®">ğŸŒ±</button>
                                    <button class="emoji-selector" data-intensity="2" data-label="è½»å¾®">ğŸƒ</button>
                                    <button class="emoji-selector" data-intensity="3" data-label="æœ‰ä¸€ç‚¹">ğŸ’§</button>
                                    <button class="emoji-selector" data-intensity="4" data-label="ä¸­ç­‰åå¼±">ğŸ’¦</button>
                                    <button class="emoji-selector" data-intensity="5" data-label="ä¸­ç­‰">âš¡</button>
                                    <button class="emoji-selector" data-intensity="6" data-label="ä¸­ç­‰åå¼º">ğŸŒŠ</button>
                                    <button class="emoji-selector" data-intensity="7" data-label="æ¯”è¾ƒå¼ºçƒˆ">ğŸ”¥</button>
                                    <button class="emoji-selector" data-intensity="8" data-label="å¼ºçƒˆ">ğŸ’¥</button>
                                    <button class="emoji-selector" data-intensity="9" data-label="éå¸¸å¼ºçƒˆ">ğŸŒ‹</button>
                                    <button class="emoji-selector" data-intensity="10" data-label="æåº¦å¼ºçƒˆ">â˜„ï¸</button>
                                </div>
                                <div class="intensity-value-display mt-4">
                                    <span class="value-number" id="intensityValue">5</span>
                                    <span class="value-label">/ 10</span>
                                </div>
                            </div>
                        </div>
                        <div class="step-card-footer">
                            <button class="btn btn-outline btn-lg" id="prevStep3">
                                <i class="fas fa-arrow-left me-2"></i>
                                ä¸Šä¸€æ­¥
                            </button>
                            <button class="btn btn-primary btn-lg" id="nextStep3">
                                ä¸‹ä¸€æ­¥
                                <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- æ­¥éª¤4ï¼šæ—¥è®°ç¼–å†™ -->
                    <div class="step-card" id="step4Card">
                        <div class="step-card-header compact">
                            <h2 class="step-title">è®°å½•ä½ çš„æ•…äº‹ ğŸ“–</h2>
                            <!-- å·²é€‰æ•°æ®æ‘˜è¦ -->
                            <div class="diary-summary" id="diarySummary">
                                <div class="summary-item">
                                    <span class="summary-label">æƒ…ç»ªï¼š</span>
                                    <span class="summary-value" id="summaryEmotions"></span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">å¼ºåº¦ï¼š</span>
                                    <span class="summary-value" id="summaryIntensity"></span>
                                </div>
                            </div>
                        </div>
                        <div class="step-card-body">
                            <textarea
                                class="form-control diary-textarea"
                                id="diaryContent"
                                rows="15"
                                placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„æƒ³æ³•ã€æ„Ÿå—å’Œç»å†...&#10;&#10;å¯ä»¥è¯•ç€å›ç­”è¿™äº›é—®é¢˜ï¼š&#10;- å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ&#10;- ä½ å½“æ—¶åœ¨æƒ³ä»€ä¹ˆï¼Ÿ&#10;- ä½ çš„èº«ä½“æœ‰ä»€ä¹ˆæ„Ÿè§‰ï¼Ÿ&#10;- ä½ åšäº†ä»€ä¹ˆï¼Ÿ&#10;&#10;æ”¾å¿ƒï¼Œè¿™é‡Œåªæœ‰ä½ è‡ªå·±èƒ½çœ‹åˆ° ğŸ’–"
                            ></textarea>
                            <div class="diary-meta mt-3">
                                <div class="word-counter">
                                    <i class="fas fa-pen me-2"></i>
                                    <span id="wordCount">0</span> å­—
                                </div>
                                <div class="image-upload-btn">
                                    <button class="btn btn-sm btn-outline" id="uploadImageBtn">
                                        <i class="fas fa-image me-2"></i>
                                        æ·»åŠ å›¾ç‰‡
                                    </button>
                                    <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                                </div>
                            </div>
                            <div class="image-preview-grid mt-3" id="imagePreviewGrid" style="display: none;"></div>
                        </div>
                        <div class="step-card-footer">
                            <button class="btn btn-outline btn-lg" id="prevStep4">
                                <i class="fas fa-arrow-left me-2"></i>
                                ä¸Šä¸€æ­¥
                            </button>
                            <button class="btn btn-primary btn-lg pulse-animation" id="saveDiary">
                                <i class="fas fa-save me-2"></i>
                                ä¿å­˜æ—¥è®°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šAIåŠ©æ‰‹å›ºå®šä¾§è¾¹æ  (4 åˆ—ï¼Œå§‹ç»ˆå¯è§) -->
                <div class="col-lg-4">
                    <div class="ai-sidebar-fixed">
                        <!-- AIæ¬¢è¿å¡ç‰‡ -->
                        <div class="ai-welcome-card">
                            <div class="ai-avatar-large">ğŸ¤–</div>
                            <h4>AIæƒ…ç»ªåˆ†æåŠ©æ‰‹</h4>
                            <p style="opacity: 0.95; margin: 0; font-size: 0.95rem;">
                                æˆ‘ä¼šé™ªä¼´ä½ å®Œæˆæ¯ä¸€æ­¥ï¼Œå¹¶åŸºäºCBTè®¤çŸ¥è¡Œä¸ºç–—æ³•ä¸ºä½ æä¾›ä¸“ä¸šçš„æƒ…ç»ªåˆ†æå’Œå»ºè®®ã€‚
                            </p>
                        </div>

                        <!-- å½“å‰æ­¥éª¤æç¤º -->
                        <div class="current-step-hint" id="currentStepHint">
                            <span class="hint-icon">ğŸ’­</span>
                            <span class="hint-text">é€‰æ‹©ä½ å½“å‰çš„æƒ…ç»ª</span>
                        </div>

                        <!-- ä½¿ç”¨æç¤ºå¡ç‰‡ -->
                        <div class="ai-tips-card">
                            <h5><i class="fas fa-lightbulb"></i> æ¸©é¦¨æç¤º</h5>
                            <div class="ai-tip-item">
                                <span class="ai-tip-icon">ğŸ¯</span>
                                <div class="ai-tip-text">
                                    <strong>çœŸå®è¡¨è¾¾ï¼š</strong>ä¸è¦å®³æ€•è´Ÿé¢æƒ…ç»ªï¼Œè¯šå®åœ°è®°å½•ä½ çš„æ„Ÿå—æ‰èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°äº†è§£è‡ªå·±ã€‚
                                </div>
                            </div>
                            <div class="ai-tip-item">
                                <span class="ai-tip-icon">ğŸ“</span>
                                <div class="ai-tip-text">
                                    <strong>è¯¦ç»†æè¿°ï¼š</strong>å°½å¯èƒ½è¯¦ç»†åœ°æè¿°äº‹ä»¶å’Œæ„Ÿå—ï¼Œè¿™ä¼šè®©AIåˆ†ææ›´å‡†ç¡®ã€‚
                                </div>
                            </div>
                            <div class="ai-tip-item">
                                <span class="ai-tip-icon">ğŸ”’</span>
                                <div class="ai-tip-text">
                                    <strong>éšç§ä¿æŠ¤ï¼š</strong>ä½ çš„æ—¥è®°åªæœ‰ä½ è‡ªå·±èƒ½çœ‹åˆ°ï¼Œè¯·æ”¾å¿ƒä¹¦å†™ã€‚
                                </div>
                            </div>
                        </div>

                        <!-- CBTå››æ­¥æ³•ä»‹ç» -->
                        <div class="ai-tips-card">
                            <h5><i class="fas fa-brain"></i> CBTå››æ­¥æ³•</h5>
                            <div class="ai-tip-item">
                                <span class="ai-tip-icon">1ï¸âƒ£</span>
                                <div class="ai-tip-text">
                                    <strong>è¯†åˆ«è´Ÿé¢æ€ç»´ï¼š</strong>æ‰¾å‡ºè‡ªåŠ¨åŒ–çš„è´Ÿé¢æƒ³æ³•
                                </div>
                            </div>
                            <div class="ai-tip-item">
                                <span class="ai-tip-icon">2ï¸âƒ£</span>
                                <div class="ai-tip-text">
                                    <strong>å¯»æ‰¾è¯æ®ï¼š</strong>æ”¶é›†æ”¯æŒå’Œåå¯¹çš„çœŸå®è¯æ®
                                </div>
                            </div>
                            <div class="ai-tip-item">
                                <span class="ai-tip-icon">3ï¸âƒ£</span>
                                <div class="ai-tip-text">
                                    <strong>ç”Ÿæˆæ›¿ä»£æ€ç»´ï¼š</strong>åˆ›é€ æ›´å¹³è¡¡çš„æƒ³æ³•
                                </div>
                            </div>
                            <div class="ai-tip-item">
                                <span class="ai-tip-icon">4ï¸âƒ£</span>
                                <div class="ai-tip-text">
                                    <strong>è¯„ä¼°æ”¹å˜ï¼š</strong>è§‚å¯Ÿæƒ…ç»ªçš„å˜åŒ–
                                </div>
                            </div>
                        </div>

                        <!-- AIåˆ†æç»“æœåŒºåŸŸï¼ˆåˆå§‹éšè—ï¼‰ -->
                        <div id="aiAnalysisContainer" style="display: none;">
                            <div class="ai-tips-card">
                                <h5><i class="fas fa-chart-line"></i> AIåˆ†æç»“æœ</h5>
                                <div id="aiPanelContent">
                                    <div class="ai-loading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">åˆ†æä¸­...</span>
                                        </div>
                                        <p class="mt-3">AIæ­£åœ¨åˆ†æä½ çš„æ—¥è®°...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ç§»åŠ¨ç«¯ï¼šåº•éƒ¨æŠ½å±‰ -->
    <div class="ai-drawer-mobile d-lg-none" id="aiDrawerMobile" style="display: none;">
        <div class="drawer-handle" id="drawerHandle">
            <div class="handle-bar"></div>
        </div>
        <div class="drawer-header">
            <div class="ai-avatar-small">ğŸ¤–</div>
            <h5>AIåˆ†æåŠ©æ‰‹</h5>
            <button class="btn-close-drawer" id="closeDrawer">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="drawer-body" id="drawerContent">
            <div class="ai-loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åˆ†æä¸­...</span>
                </div>
                <p class="mt-3">AIæ­£åœ¨åˆ†æä½ çš„æ—¥è®°...</p>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}?v=20241205"></script>
    <script src="{{ url_for('static', filename='js/diary_new.js') }}"></script>

    <script>
        // æ­¥éª¤æç¤ºæ–‡æœ¬
        const stepHints = {
            1: { icon: 'ğŸ’­', text: 'é€‰æ‹©ä½ å½“å‰çš„æƒ…ç»ª' },
            2: { icon: 'ğŸŒŸ', text: 'æè¿°è§¦å‘æƒ…ç»ªçš„äº‹ä»¶' },
            3: { icon: 'ğŸ’«', text: 'æ ‡è®°ä½ çš„æƒ…ç»ªå¼ºåº¦' },
            4: { icon: 'ğŸ“–', text: 'è¯¦ç»†è®°å½•ä½ çš„æ„Ÿå—' }
        };

        // ç›‘å¬æ­¥éª¤å˜åŒ–ï¼Œæ›´æ–°æç¤º
        function updateStepHint(step) {
            const hintElement = document.getElementById('currentStepHint');
            const hint = stepHints[step];
            if (hint && hintElement) {
                hintElement.querySelector('.hint-icon').textContent = hint.icon;
                hintElement.querySelector('.hint-text').textContent = hint.text;
            }
        }

        // ç›‘å¬æ­¥éª¤å¡ç‰‡çš„æ˜¾ç¤º/éšè—
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === 'class') {
                    const target = mutation.target;
                    if (target.classList.contains('active')) {
                        const stepId = target.id;
                        const stepNumber = parseInt(stepId.replace('step', '').replace('Card', ''));
                        updateStepHint(stepNumber);
                    }
                }
            });
        });

        // è§‚å¯Ÿæ‰€æœ‰æ­¥éª¤å¡ç‰‡
        document.querySelectorAll('.step-card').forEach(card => {
            observer.observe(card, { attributes: true });
        });
    </script>
</body>
</html>
