<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººèµ„æ–™ - CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆ</title>
    <meta name="description" content="ç®¡ç†æ‚¨çš„CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆä¸ªäººèµ„æ–™å’Œè®¾ç½®">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="alternate icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Nunito:wght@300;400;600;700;800;900&display=swap"
        rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        /* ä¸ªäººèµ„æ–™é¡µä¸“å±æ ·å¼ - è¦†ç›–/è¡¥å……å…¨å±€æ ·å¼ */
        .profile-hero-section {
            background: var(--gradient-sky);
            padding: 3rem 0 5rem;
            position: relative;
            margin-bottom: -3rem;
            /* è®©å¡ç‰‡é‡å  */
            overflow: hidden;
        }

        .profile-card-container {
            position: relative;
            z-index: 10;
        }

        .profile-main-card {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-cute);
            padding: 3rem 2rem;
            text-align: center;
            border: 4px solid white;
            position: relative;
            overflow: hidden;
        }

        .profile-main-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: var(--gradient-candy);
            opacity: 0.3;
            border-radius: var(--radius-xl) var(--radius-xl) 50% 50%;
        }

        .profile-avatar-wrapper {
            position: relative;
            width: 140px;
            height: 140px;
            margin: 0 auto 1.5rem;
        }

        .profile-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            border: 5px solid white;
            box-shadow: var(--shadow-game);
            position: relative;
            z-index: 2;
        }

        .avatar-decoration {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 2rem;
            animation: bounce 2s infinite;
            z-index: 3;
        }

        .profile-username {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: var(--gradient-sunset);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .profile-join-date {
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        /* æ¸¸æˆåŒ–ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .game-stat-item {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            border: 2px solid transparent;
            /* é¢„ç•™ç»™ hover */
            transition: all 0.3s var(--bounce);
        }

        .game-stat-item:hover {
            transform: translateY(-5px);
            background: white;
            border-color: var(--primary-pink);
            box-shadow: var(--shadow-clean);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 900;
            color: var(--primary-blue);
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 700;
        }

        /* æƒ…ç»ªæ ‡ç­¾å¢™ */
        .emotion-wall {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-game);
            margin-bottom: 2rem;
            border: 3px solid #f0f0f0;
        }

        .emotion-wall-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
        }

        .emotion-tag-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: linear-gradient(135deg, #FFF5F8 0%, #F0F9FF 100%);
            border: 2px solid rgba(255, 107, 157, 0.2);
            color: var(--text-secondary);
            font-weight: 700;
            margin: 0.25rem;
            transition: all 0.3s var(--bounce);
        }

        .emotion-tag-pill:hover {
            transform: scale(1.1) rotate(2deg);
            border-color: var(--primary-pink);
            background: white;
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.2);
        }

        .emotion-count {
            background: var(--primary-pink);
            color: white;
            border-radius: 10px;
            padding: 0.1rem 0.5rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        /* æœ€è¿‘æ´»åŠ¨åˆ—è¡¨ */
        .activity-list {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-game);
            border: 3px solid #f0f0f0;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 2px dashed #f0f0f0;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--primary-purple);
            flex-shrink: 0;
        }

        .activity-content {
            flex-grow: 1;
        }

        .activity-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--text-light);
            font-weight: 600;
        }

        /* æˆå°±å¾½ç«  */
        .achievement-badge {
            text-align: center;
            padding: 1rem;
            transition: transform 0.3s var(--bounce);
        }

        .achievement-badge:hover {
            transform: scale(1.1);
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }

        .achievement-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
    </style>
</head>

<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <span class="navbar-logo-emoji">ğŸ’–</span>
                CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/diary">æƒ…ç»ªæ—¥è®°</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/postcards">ğŸ¦Š æ˜ä¿¡ç‰‡</a>
                    </li>
                </ul>
                <div class="d-flex gap-2 align-items-center">
                    <div id="authUser" class="d-flex gap-2 align-items-center">
                        <div class="dropdown">
                            <button class="btn btn-outline dropdown-toggle" type="button" id="userDropdown"
                                data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="username">ç”¨æˆ·</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item active" href="/profile"><i
                                            class="fas fa-user me-2"></i>ä¸ªäººèµ„æ–™</a></li>
                                <li><a class="dropdown-item" href="/settings"><i class="fas fa-cog me-2"></i>è®¾ç½®</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="javascript:void(0);" id="logoutBtn"><i
                                            class="fas fa-sign-out-alt me-2"></i>é€€å‡ºç™»å½•</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero åŒºåŸŸèƒŒæ™¯ -->
    <section class="profile-hero-section">
        <!-- æ¼‚æµ®è£…é¥° -->
        <div class="floating-emoji" style="top: 10%; left: 5%; animation-delay: 0s;">ğŸŒŸ</div>
        <div class="floating-emoji" style="top: 20%; right: 10%; animation-delay: 1s;">ğŸ’–</div>
        <div class="floating-emoji" style="bottom: 30%; left: 15%; animation-delay: 2s;">ğŸˆ</div>

        <div class="container text-center text-white position-relative" style="z-index: 1;">
            <h1 class="display-4 fw-bold mb-3" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">æˆ‘çš„å†’é™©æ¡£æ¡ˆ</h1>
            <p class="lead fw-bold opacity-75">è®°å½•æˆé•¿ï¼Œè§è¯æ¯ä¸€æ¬¡èœ•å˜</p>
        </div>
    </section>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="container profile-card-container mb-5">
        <div class="row">
            <!-- å·¦ä¾§ï¼šä¸ªäººä¿¡æ¯å¡ç‰‡ -->
            <div class="col-lg-4 mb-4">
                <div class="profile-main-card animate-fade-in-up">
                    <div class="profile-avatar-wrapper">
                        <div class="profile-avatar">
                            ğŸ§’
                        </div>
                        <div class="avatar-decoration">âœ¨</div>
                    </div>
                    <h2 class="profile-username" id="profileUsername">åŠ è½½ä¸­...</h2>
                    <div class="profile-join-date">
                        <i class="fas fa-calendar-alt me-2"></i>
                        åŠ å…¥äº <span id="memberSince">-</span>
                    </div>

                    <div class="stats-grid">
                        <div class="game-stat-item">
                            <div class="stat-value" id="streakDays">0</div>
                            <div class="stat-label">è¿ç»­è®°å½•(å¤©)</div>
                        </div>
                        <div class="game-stat-item">
                            <div class="stat-value" id="gameProgress">Lv.1</div>
                            <div class="stat-label">å†’é™©ç­‰çº§</div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="game-stat-item">
                            <div class="stat-value" id="totalDiaries">0</div>
                            <div class="stat-label">æ—¥è®°æ€»æ•°</div>
                        </div>
                        <div class="game-stat-item">
                            <div class="stat-value" id="recentDiaries">0</div>
                            <div class="stat-label">æœ¬å‘¨è®°å½•</div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <a href="/settings" class="btn btn-outline btn-lg">
                            <i class="fas fa-cog me-2"></i>ç¼–è¾‘èµ„æ–™
                        </a>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šè¯¦ç»†æ•°æ® -->
            <div class="col-lg-8">
                <!-- æˆå°±å±•ç¤º -->
                <div class="activity-list mb-4 animate-fade-in-up" style="animation-delay: 0.1s;">
                    <div class="emotion-wall-title">
                        <i class="fas fa-trophy text-warning"></i>
                        æˆ‘çš„æˆå°±
                    </div>
                    <div class="row" id="achievementList">
                        <div class="col-4 col-md-3 achievement-badge">
                            <div class="achievement-icon">ğŸŒ±</div>
                            <div class="achievement-name">åˆå­¦è€…</div>
                        </div>
                        <div class="col-4 col-md-3 achievement-badge">
                            <div class="achievement-icon" style="opacity: 0.3; filter: grayscale(1);">ğŸ”¥</div>
                            <div class="achievement-name text-muted">åšæŒè€…</div>
                        </div>
                        <div class="col-4 col-md-3 achievement-badge">
                            <div class="achievement-icon" style="opacity: 0.3; filter: grayscale(1);">ğŸ‘‘</div>
                            <div class="achievement-name text-muted">æƒ…ç»ªå¤§å¸ˆ</div>
                        </div>
                        <div class="col-4 col-md-3 achievement-badge">
                            <div class="achievement-icon" style="opacity: 0.3; filter: grayscale(1);">ğŸ¦Š</div>
                            <div class="achievement-name text-muted">æ¢é™©å®¶</div>
                        </div>
                    </div>
                </div>

                <!-- æƒ…ç»ªåˆ†å¸ƒ -->
                <div class="emotion-wall animate-fade-in-up" style="animation-delay: 0.2s;">
                    <div class="emotion-wall-title">
                        <i class="fas fa-heart text-danger"></i>
                        æ”¶é›†çš„æƒ…ç»ªç¢ç‰‡
                    </div>
                    <div id="emotionStats" class="d-flex flex-wrap">
                        <span class="text-muted">æ­£åœ¨åŠ è½½æƒ…ç»ªæ•°æ®...</span>
                    </div>
                </div>

                <!-- æœ€è¿‘æ´»åŠ¨ -->
                <div class="activity-list animate-fade-in-up" style="animation-delay: 0.3s;">
                    <div class="emotion-wall-title">
                        <i class="fas fa-history text-primary"></i>
                        å†’é™©è¶³è¿¹
                    </div>
                    <div id="recentActivities">
                        <p class="text-muted">åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="mt-5 py-4" style="background: white !important; color: #6c757d !important;">
        <div class="container text-center">
            <h5 class="mb-3" style="color: var(--primary-pink) !important;">
                <i class="fas fa-heart-pulse me-2"></i>
                CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆ
            </h5>
            <p class="mb-2" style="color: #6c757d !important;">
                Â© 2024 å¿ƒçµå®ˆæŠ¤è€… - ç”¨çˆ±ä¸ç§‘å­¦ç–—æ„ˆå¿ƒçµ
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}?v=20241206"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // ç­‰å¾…authManageråˆå§‹åŒ– (æ¥è‡ªmain.js)
            if (window.authManager && !window.authManager.isAuthenticated()) {
                window.location.href = '/login';
                return;
            }

            // æ›´æ–°å¯¼èˆªæ ç”¨æˆ·ä¿¡æ¯
            if (window.updateAuthUI) {
                window.updateAuthUI();
            }

            // åŠ è½½æ•°æ®
            await Promise.all([
                loadUserProfile(),
                loadDiaryStats(),
                loadRecentActivities()
            ]);
        });

        async function loadUserProfile() {
            try {
                const response = await window.apiClient.get('/auth/profile');
                if (response && response.ok) {
                    const user = response.data.user;
                    document.getElementById('profileUsername').textContent = user.username;
                    // document.getElementById('username').textContent = user.username; // main.jså·²å¤„ç†

                    const joinDate = new Date(user.created_at);
                    document.getElementById('memberSince').textContent = joinDate.toLocaleDateString('zh-CN');
                }
            } catch (error) {
                console.error('Profile load error:', error);
            }
        }

        async function loadDiaryStats() {
            try {
                const response = await window.apiClient.get('/diary/stats');
                if (response && response.ok) {
                    const stats = response.data;
                    document.getElementById('totalDiaries').textContent = stats.total_diaries;
                    document.getElementById('recentDiaries').textContent = stats.recent_diaries;
                    // document.getElementById('streakDays').textContent = stats.streak || 0; // å‡è®¾APIæœ‰è¿™ä¸ªå­—æ®µï¼Œæ²¡æœ‰åˆ™ä¿æŒé»˜è®¤

                    // æ¸²æŸ“æƒ…ç»ªæ ‡ç­¾
                    const emotionContainer = document.getElementById('emotionStats');
                    if (Object.keys(stats.emotion_stats).length > 0) {
                        let html = '';
                        for (const [emotion, count] of Object.entries(stats.emotion_stats)) {
                            html += `
                                <div class="emotion-tag-pill">
                                    ${emotion}
                                    <span class="emotion-count">${count}</span>
                                </div>
                            `;
                        }
                        emotionContainer.innerHTML = html;
                    } else {
                        emotionContainer.innerHTML = '<p class="text-muted">è¿˜æ²¡æœ‰æ”¶é›†åˆ°æƒ…ç»ªç¢ç‰‡å“¦ï¼Œå¿«å»å†™æ—¥è®°å§ï¼</p>';
                    }
                }
            } catch (error) {
                console.error('Stats load error:', error);
            }
        }

        async function loadRecentActivities() {
            try {
                const response = await window.apiClient.get('/diary?limit=5');
                if (response && response.ok) {
                    const diaries = response.data.diaries;
                    const container = document.getElementById('recentActivities');

                    if (diaries.length > 0) {
                        let html = '';
                        diaries.forEach(diary => {
                            const date = new Date(diary.created_at);
                            const timeStr = getRelativeTime(date);

                            html += `
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-pen"></i>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">å®Œæˆäº†ä¸€ç¯‡æƒ…ç»ªæ—¥è®°</div>
                                        <div class="text-muted small text-truncate" style="max-width: 250px;">${diary.content}</div>
                                    </div>
                                    <div class="activity-time">${timeStr}</div>
                                </div>
                            `;
                        });
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p class="text-muted">æš‚æ— å†’é™©è®°å½•</p>';
                    }
                }
            } catch (error) {
                console.error('Activities load error:', error);
            }
        }

        function getRelativeTime(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'åˆšåˆš';
            if (diff < 3600) return Math.floor(diff / 60) + 'åˆ†é’Ÿå‰';
            if (diff < 86400) return Math.floor(diff / 3600) + 'å°æ—¶å‰';
            if (diff < 604800) return Math.floor(diff / 86400) + 'å¤©å‰';
            return date.toLocaleDateString('zh-CN');
        }
    </script>
</body>

</html>