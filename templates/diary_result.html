<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è®°ä¿å­˜æˆåŠŸ - CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆ</title>
    <meta name="description" content="æ‚¨çš„æƒ…ç»ªæ—¥è®°å·²ä¿å­˜ï¼Œå°æ©˜é‚€è¯·ä½ å»æ¢é™©ï¼">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="alternate icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        .result-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .result-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-purple);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* æˆåŠŸä¿å­˜æç¤º */
        .success-banner {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 30px;
        }

        .success-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* æ¢é™©é‚€è¯·å¡ç‰‡ */
        .adventure-invite {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .adventure-invite::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .fox-icon {
            font-size: 80px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .adventure-invite h2 {
            position: relative;
            z-index: 1;
        }

        .adventure-invite p {
            position: relative;
            z-index: 1;
            opacity: 0.9;
        }

        .btn-adventure {
            position: relative;
            z-index: 1;
            padding: 16px 48px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 30px;
            background: white;
            color: #667eea;
            border: none;
            transition: all 0.3s;
        }

        .btn-adventure:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            background: white;
            color: #764ba2;
        }

        /* æ˜ä¿¡ç‰‡å±•ç¤º */
        .postcard-section {
            background: linear-gradient(135deg, #fff5f5 0%, #fff0e6 100%);
            border: 2px solid #ffd6b3;
        }

        .postcard-preview {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }

        .postcard-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .postcard-image-placeholder {
            width: 100%;
            height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #ff8c42;
        }

        .postcard-image-placeholder .fox-writing {
            font-size: 60px;
            animation: writing 1.5s ease-in-out infinite;
        }

        @keyframes writing {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .postcard-content {
            padding: 25px;
        }

        .postcard-message {
            font-size: 16px;
            line-height: 1.8;
            color: #5a4a3a;
            white-space: pre-line;
        }

        .postcard-location {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #fff0e6;
            border-radius: 20px;
            font-size: 14px;
            color: #ff8c42;
            margin-bottom: 15px;
        }

        /* ç­‰å¾…çŠ¶æ€ */
        .waiting-section {
            text-align: center;
            padding: 40px;
        }

        .waiting-section .fox-icon {
            font-size: 60px;
            opacity: 0.8;
        }

        /* æ¢é™©é¢„è§ˆåŒºåŸŸ */
        .adventure-preview-section {
            background: linear-gradient(135deg, #e8f4f8 0%, #d4e8f2 100%);
            border: 2px solid #a8d4e6;
        }

        .challenge-preview {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .challenge-monster {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .monster-icon {
            font-size: 40px;
        }

        .monster-info h4 {
            margin: 0;
            font-size: 18px;
            color: #5a4a6a;
        }

        .monster-info p {
            margin: 0;
            font-size: 14px;
            color: #888;
        }

        .challenge-question {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-size: 16px;
            color: #333;
            border-left: 4px solid var(--primary-purple);
        }

        .challenge-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .challenge-generating {
            text-align: center;
            padding: 30px;
            color: #667eea;
        }

        .challenge-generating .spinner-border {
            width: 2rem;
            height: 2rem;
        }

        /* æ˜ä¿¡ç‰‡é¢„è§ˆå°å¡ç‰‡ */
        .postcard-mini-preview {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .postcard-mini-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .postcard-mini-placeholder {
            width: 100%;
            height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #ff8c42;
        }

        .postcard-mini-placeholder .writing-icon {
            font-size: 40px;
            animation: writing 1.5s ease-in-out infinite;
        }

        .postcard-mini-info {
            padding: 12px;
            text-align: center;
            font-size: 14px;
            color: #666;
        }

        /* æ“ä½œæŒ‰é’® */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn-action {
            flex: 1;
            min-width: 180px;
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: var(--primary-purple);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <span class="navbar-logo-emoji">ğŸ’–</span>
                CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/diary">æƒ…ç»ªæ—¥è®°</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/postcards">ğŸ¦Š æ˜ä¿¡ç‰‡</a>
                    </li>
                </ul>
                <div class="d-flex gap-2 align-items-center">
                    <div id="authUser" class="d-flex gap-2 align-items-center">
                        <div class="dropdown">
                            <button class="btn btn-outline dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="username">ç”¨æˆ·</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>ä¸ªäººèµ„æ–™</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="javascript:void(0);" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>é€€å‡ºç™»å½•</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="result-container">
        <!-- æˆåŠŸä¿å­˜æç¤º -->
        <div class="success-banner">
            <div class="success-icon">âœ…</div>
            <h3>æ—¥è®°ä¿å­˜æˆåŠŸï¼</h3>
            <p class="mb-0">è®°å½•æƒ…ç»ªæ˜¯æˆé•¿çš„ç¬¬ä¸€æ­¥ï¼Œä½ åšå¾—å¾ˆæ£’~</p>
        </div>

        <!-- æ˜ä¿¡ç‰‡åŒºåŸŸ - æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹ -->
        <div id="postcardArea">
            <!-- é»˜è®¤ï¼šç­‰å¾…æ¢é™© -->
            <div id="waitingAdventure" class="result-section adventure-invite">
                <div class="fox-icon">ğŸ¦Š</div>
                <h2 class="mb-3">å°æ©˜æƒ³é‚€è¯·ä½ å»æ¢é™©ï¼</h2>
                <p class="mb-4">åœ¨è¿·é›¾æ£®æ—ä¸­æ¶ˆé™¤è´Ÿé¢æƒ³æ³•çš„æ€ªç‰©ï¼Œ<br>å®Œæˆæ¢é™©åï¼Œå°æ©˜ä¼šç»™ä½ å†™ä¸€å°æ¸©æš–çš„å›ä¿¡å“¦~</p>
                <a href="/adventure/{{ diary_id }}" class="btn btn-adventure">
                    <i class="fas fa-hiking me-2"></i>å¼€å§‹æ¢é™©
                </a>
                <div class="mt-4" style="font-size: 14px; opacity: 0.8; position: relative; z-index: 1;">
                    <i class="fas fa-info-circle me-1"></i>å®Œæˆæ¢é™©æ‰èƒ½æ”¶åˆ°å°æ©˜çš„æ˜ä¿¡ç‰‡
                </div>
            </div>

            <!-- æ¢é™©é¢˜ç›®é¢„è§ˆ -->
            <div id="adventurePreview" class="result-section adventure-preview-section d-none">
                <div class="section-title">
                    <i class="fas fa-dragon"></i>
                    ä»Šæ—¥æ¢é™©æŒ‘æˆ˜é¢„è§ˆ
                </div>
                <div id="challengeList" class="challenge-list">
                    <!-- åŠ¨æ€åŠ è½½æŒ‘æˆ˜é¢˜ç›® -->
                    <div class="challenge-generating">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 mb-0">å°æ©˜æ­£åœ¨å‡†å¤‡ä»Šå¤©çš„æ¢é™©æŒ‘æˆ˜...</p>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <a href="/adventure/{{ diary_id }}" class="btn btn-primary">
                        <i class="fas fa-hiking me-2"></i>å¼€å§‹æ¢é™©
                    </a>
                </div>
            </div>

            <!-- æ˜ä¿¡ç‰‡é¢„è§ˆï¼ˆåœ¨æ¢é™©å‰æ˜¾ç¤ºï¼‰ -->
            <div id="postcardPreview" class="result-section postcard-section d-none">
                <div class="section-title">
                    <i class="fas fa-envelope"></i>
                    å°æ©˜çš„æ˜ä¿¡ç‰‡
                </div>
                <div class="postcard-mini-preview">
                    <div id="postcardPreviewImage" class="postcard-mini-placeholder">
                        <div class="writing-icon">ğŸ¦Šâœï¸</div>
                        <p class="mt-2 mb-0">ç­‰å¾…æ¢é™©å®Œæˆåç”Ÿæˆ...</p>
                    </div>
                    <div class="postcard-mini-info">
                        å®Œæˆæ¢é™©åï¼Œå°æ©˜ä¼šç»™ä½ å†™ä¸€å°ä¸“å±æ˜ä¿¡ç‰‡
                    </div>
                </div>
            </div>

            <!-- æ˜ä¿¡ç‰‡ç”Ÿæˆä¸­ -->
            <div id="postcardPending" class="result-section postcard-section d-none">
                <div class="section-title">
                    <i class="fas fa-envelope-open-text"></i>
                    å°æ©˜çš„å›ä¿¡
                </div>
                <div class="postcard-preview">
                    <div class="postcard-image-placeholder">
                        <div class="fox-writing">ğŸ¦Šâœï¸</div>
                        <p class="mt-3 mb-0">å°æ©˜æ­£åœ¨ç»™ä½ å†™ä¿¡...</p>
                    </div>
                    <div class="postcard-content">
                        <div class="text-center py-4">
                            <div class="loading-spinner"></div>
                            <p class="mt-3 text-muted">è¯·ç¨ç­‰ï¼Œå°æ©˜æ­£åœ¨è®¤çœŸå†™å›ä¿¡ç»™ä½ ~</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ˜ä¿¡ç‰‡å·²å®Œæˆ -->
            <div id="postcardCompleted" class="result-section postcard-section d-none">
                <div class="section-title">
                    <i class="fas fa-envelope-open-text"></i>
                    å°æ©˜çš„å›ä¿¡
                </div>
                <div class="postcard-preview">
                    <img id="postcardImage" class="postcard-image" src="" alt="å°æ©˜çš„æ˜ä¿¡ç‰‡">
                    <div class="postcard-content">
                        <div id="postcardLocation" class="postcard-location">
                            <i class="fas fa-map-marker-alt"></i>
                            <span></span>
                        </div>
                        <div id="postcardMessage" class="postcard-message"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
            <a href="/diary" class="btn btn-outline btn-action">
                <i class="fas fa-arrow-left me-2"></i>è¿”å›æ—¥è®°åˆ—è¡¨
            </a>
            <a href="/postcards" class="btn btn-success btn-action" id="viewPostcardsBtn">
                <i class="fas fa-envelope me-2"></i>æŸ¥çœ‹æ˜ä¿¡ç‰‡
            </a>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Main JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}?v=20241206"></script>

    <script>
        const diaryId = {{ diary_id }};
        const token = localStorage.getItem('access_token');
        let pollingInterval = null;

        document.addEventListener('DOMContentLoaded', async function() {
            if (!token) {
                window.location.href = '/login';
                return;
            }

            // æ£€æŸ¥æ˜ä¿¡ç‰‡çŠ¶æ€
            await checkPostcardStatus();
        });

        async function checkPostcardStatus() {
            try {
                const response = await fetch(`/api/postcard/by-diary/${diaryId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.postcard) {
                        showPostcard(data.postcard);
                    }
                } else if (response.status === 404) {
                    // è¿˜æ²¡æœ‰æ˜ä¿¡ç‰‡ï¼Œæ£€æŸ¥æ¢é™©çŠ¶æ€å¹¶æ˜¾ç¤ºé¢„è§ˆ
                    await checkAdventureAndShowPreview();
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ˜ä¿¡ç‰‡çŠ¶æ€å¤±è´¥:', error);
                await checkAdventureAndShowPreview();
            }
        }

        // æ£€æŸ¥æ¢é™©çŠ¶æ€å¹¶æ˜¾ç¤ºé¢˜ç›®é¢„è§ˆ
        async function checkAdventureAndShowPreview() {
            try {
                const response = await fetch(`/api/adventure/session/${diaryId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();

                    if (data.status === 'generating') {
                        // æ¢é™©æ­£åœ¨ç”Ÿæˆä¸­ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        showAdventurePreview(null, true);
                        // 3ç§’åé‡æ–°æ£€æŸ¥
                        setTimeout(checkAdventureAndShowPreview, 3000);
                    } else if (data.challenges && data.challenges.length > 0) {
                        // æ¢é™©å·²ç”Ÿæˆï¼Œæ˜¾ç¤ºé¢˜ç›®é¢„è§ˆ
                        showAdventurePreview(data, false);
                    } else {
                        // æ²¡æœ‰æ¢é™©æ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤é‚€è¯·
                        showWaitingAdventure();
                    }
                } else {
                    // æ²¡æœ‰æ¢é™©ä¼šè¯ï¼Œæ˜¾ç¤ºé»˜è®¤é‚€è¯·
                    showWaitingAdventure();
                }
            } catch (error) {
                console.error('è·å–æ¢é™©çŠ¶æ€å¤±è´¥:', error);
                showWaitingAdventure();
            }
        }

        // æ˜¾ç¤ºæ¢é™©é¢˜ç›®é¢„è§ˆ
        function showAdventurePreview(adventureData, isGenerating) {
            document.getElementById('waitingAdventure').classList.add('d-none');
            document.getElementById('adventurePreview').classList.remove('d-none');
            document.getElementById('postcardPreview').classList.remove('d-none');
            document.getElementById('postcardPending').classList.add('d-none');
            document.getElementById('postcardCompleted').classList.add('d-none');

            const challengeList = document.getElementById('challengeList');

            if (isGenerating || !adventureData) {
                // æ­£åœ¨ç”Ÿæˆä¸­
                challengeList.innerHTML = `
                    <div class="challenge-generating">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 mb-0">å°æ©˜æ­£åœ¨å‡†å¤‡ä»Šå¤©çš„æ¢é™©æŒ‘æˆ˜...</p>
                    </div>
                `;
                return;
            }

            // æ˜¾ç¤ºé¢˜ç›®é¢„è§ˆ
            const challenges = adventureData.challenges || [];
            const monsters = adventureData.monsters || [];

            if (challenges.length === 0) {
                challengeList.innerHTML = `
                    <div class="challenge-generating">
                        <p class="mb-0">æ¢é™©é¢˜ç›®å‡†å¤‡ä¸­...</p>
                    </div>
                `;
                return;
            }

            // æ„å»ºé¢˜ç›®é¢„è§ˆHTMLï¼ˆåªæ˜¾ç¤ºæ€ªç‰©å’Œé¢˜ç›®ï¼Œä¸æ˜¾ç¤ºé€‰é¡¹ï¼Œé¿å…å‰§é€ï¼‰
            let html = '';
            challenges.forEach((challenge, index) => {
                const monster = monsters[index] || {};
                const monsterEmoji = getMonsterEmoji(monster.type || challenge.monster_type);

                html += `
                    <div class="challenge-preview">
                        <div class="challenge-monster">
                            <div class="monster-icon">${monsterEmoji}</div>
                            <div class="monster-info">
                                <h4>${monster.name || challenge.monster_name || 'æ€ç»´æ€ªç‰©'}</h4>
                                <p>${monster.description || challenge.monster_desc || 'ä¸€ä¸ªå›°æ‰°ä½ çš„æƒ³æ³•'}</p>
                            </div>
                        </div>
                        <div class="challenge-question">
                            <strong>æŒ‘æˆ˜ ${index + 1}:</strong> ${challenge.question || 'æ€è€ƒé¢˜ç›®åŠ è½½ä¸­...'}
                        </div>
                    </div>
                `;
            });

            challengeList.innerHTML = html;
        }

        // æ ¹æ®æ€ªç‰©ç±»å‹è·å–emoji
        function getMonsterEmoji(type) {
            const emojiMap = {
                'ç¾éš¾åŒ–æ€ç»´': 'ğŸŒªï¸',
                'éé»‘å³ç™½': 'âš«',
                'ä»¥åæ¦‚å…¨': 'ğŸ”',
                'è¯»å¿ƒæœ¯': 'ğŸ”®',
                'æƒ…ç»ªæ¨ç†': 'ğŸ’”',
                'è´´æ ‡ç­¾': 'ğŸ·ï¸',
                'åº”è¯¥é™ˆè¿°': 'ğŸ“œ',
                'è¿‡åº¦è‡ªè´£': 'ğŸ˜”',
                'default': 'ğŸ‘¾'
            };
            return emojiMap[type] || emojiMap['default'];
        }

        function showWaitingAdventure() {
            document.getElementById('waitingAdventure').classList.remove('d-none');
            document.getElementById('adventurePreview').classList.add('d-none');
            document.getElementById('postcardPreview').classList.add('d-none');
            document.getElementById('postcardPending').classList.add('d-none');
            document.getElementById('postcardCompleted').classList.add('d-none');
        }

        function showPostcard(postcard) {
            document.getElementById('waitingAdventure').classList.add('d-none');
            document.getElementById('adventurePreview').classList.add('d-none');
            document.getElementById('postcardPreview').classList.add('d-none');

            if (postcard.status === 'pending' || postcard.status === 'generating') {
                // æ˜ä¿¡ç‰‡ç”Ÿæˆä¸­
                document.getElementById('postcardPending').classList.remove('d-none');
                document.getElementById('postcardCompleted').classList.add('d-none');

                // å¼€å§‹è½®è¯¢
                if (!pollingInterval) {
                    pollingInterval = setInterval(checkPostcardStatus, 3000);
                }
            } else {
                // æ˜ä¿¡ç‰‡å·²å®Œæˆ
                document.getElementById('postcardPending').classList.add('d-none');
                document.getElementById('postcardCompleted').classList.remove('d-none');

                // åœæ­¢è½®è¯¢
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }

                // å¡«å……å†…å®¹
                const imgEl = document.getElementById('postcardImage');
                if (postcard.image_url) {
                    imgEl.src = postcard.image_url;
                    imgEl.style.display = 'block';
                } else {
                    imgEl.style.display = 'none';
                }

                document.getElementById('postcardLocation').querySelector('span').textContent =
                    postcard.location_name || 'å°æ©˜çš„å°çª';
                document.getElementById('postcardMessage').textContent =
                    postcard.message || 'äº²çˆ±çš„ä¸»äººï¼Œè°¢è°¢ä½ è®°å½•ä»Šå¤©çš„å¿ƒæƒ…~';
            }
        }

        // é€€å‡ºç™»å½•
        document.getElementById('logoutBtn')?.addEventListener('click', function() {
            localStorage.removeItem('access_token');
            window.location.href = '/login';
        });

        // é¡µé¢ç¦»å¼€æ—¶åœæ­¢è½®è¯¢
        window.addEventListener('beforeunload', function() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    </script>
</body>
</html>
