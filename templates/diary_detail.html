<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日记详情 - CBT情绪日记游戏</title>
    <meta name="description" content="查看您的CBT情绪日记详情和分析结果">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="alternate icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-heart me-2"></i>心灵守护者
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/diary"><i class="fas fa-book me-1"></i>日记</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/game"><i class="fas fa-gamepad me-1"></i>游戏</a>
                    </li>
                </ul>

                <div class="navbar-nav">
                    <!-- 未登录状态 -->
                    <div id="auth-guest" class="d-flex">
                        <a class="nav-link login-link" href="/login">登录</a>
                        <a class="nav-link register-link" href="/register">注册</a>
                    </div>

                    <!-- 已登录状态 -->
                    <div id="auth-user" class="dropdown d-none">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="username">用户</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/profile" style="cursor: pointer;"><i class="fas fa-user me-2"></i>个人资料</a></li>
                            <li><a class="dropdown-item" href="/settings" style="cursor: pointer;"><i class="fas fa-cog me-2"></i>设置</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="javascript:void(0);" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>退出登录</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <main class="container my-5">
        <!-- Alert容器 -->
        <div id="alertContainer" class="mb-3"></div>

        <!-- 日记详情 -->
        <div class="diary-detail">
            <div class="diary-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 id="diaryTitle">日记详情</h1>
                        <p class="text-muted mb-2">
                            <i class="fas fa-calendar me-2"></i>
                            <span id="diaryDate">加载中...</span>
                        </p>
                    </div>
                    <div class="action-buttons">
                        <a href="/diary" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>返回
                        </a>
                        <a href="#" id="editBtn" class="btn btn-primary">
                            <i class="fas fa-edit me-2"></i>编辑
                        </a>
                    </div>
                </div>
            </div>

            <!-- 情绪标签 -->
            <div id="emotionTags" class="emotion-tags">
                <!-- 情绪标签将动态加载 -->
            </div>

            <!-- 日记内容 -->
            <div id="diaryContent" class="diary-content">
                <!-- 日记内容将动态加载 -->
            </div>

            <!-- 分析状态提示 -->
            <div id="pendingAnalysis" class="pending-analysis" style="display: none;">
                <div class="loading-spinner mb-3"></div>
                <h4>正在分析您的情绪...</h4>
                <p class="text-muted">AI正在分析您的日记内容，这可能需要几秒钟时间</p>
                <button class="btn btn-primary mt-3" onclick="refreshAnalysis()">
                    <i class="fas fa-sync me-2"></i>刷新分析
                </button>
            </div>
        </div>

        <!-- AI情绪分析 -->
        <div id="analysisSection" class="analysis-section" style="display: none;">
            <h2 class="mb-4">
                <i class="fas fa-brain me-2"></i>AI情绪分析
            </h2>

            <div class="row">
                <div class="col-md-6">
                    <div class="emotion-dimension">
                        <div class="dimension-label">主要情绪</div>
                        <div class="dimension-score" id="overallEmotion">-</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="emotion-dimension">
                        <div class="dimension-label">情绪强度</div>
                        <div class="dimension-score" id="emotionIntensity">-</div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="emotion-dimension">
                        <div class="dimension-label">情绪维度分析</div>
                        <div id="emotionDimensions">
                            <!-- 情绪维度将动态加载 -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-12">
                    <div class="emotion-dimension">
                        <div class="dimension-label">关键词提取</div>
                        <div id="keyWords" class="d-flex flex-wrap gap-2">
                            <!-- 关键词将动态加载 -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="confidence-meter">
                <span>分析置信度：</span>
                <div class="confidence-bar">
                    <div id="confidenceFill" class="confidence-fill" style="width: 0%"></div>
                </div>
                <span id="confidenceScore">0%</span>
            </div>
        </div>

        <!-- CBT洞察 -->
        <div id="cbtInsights" class="cbt-insights" style="display: none;">
            <h2 class="mb-4">
                <i class="fas fa-lightbulb me-2"></i>CBT认知洞察
            </h2>

            <div class="insight-item">
                <div class="insight-title">识别的情绪模式</div>
                <div id="emotionPatterns">
                    <!-- 情绪模式将动态加载 -->
                </div>
            </div>

            <div class="insight-item">
                <div class="insight-title">可能的认知偏差</div>
                <div id="cognitiveBiases">
                    <!-- 认知偏差将动态加载 -->
                </div>
            </div>

            <div class="insight-item">
                <div class="insight-title">建议的思维重构</div>
                <div id="reframingSuggestions">
                    <!-- 思维重构建议将动态加载 -->
                </div>
            </div>

            <div class="insight-item">
                <div class="insight-title">CBT实践建议</div>
                <div id="cbtSuggestions">
                    <!-- CBT实践建议将动态加载 -->
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-light mt-5 py-4">
        <div class="container text-center">
            <p class="text-muted mb-0">© 2024 心灵守护者 - 用爱与科学疗愈心灵</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script>
        // 日记详情页面脚本
        let diaryId = null;
        let refreshTimer = null;

        // 等待authManager初始化完成
        function waitForAuthManager() {
            return new Promise((resolve) => {
                if (window.authManager && window.apiClient) {
                    resolve();
                } else {
                    const interval = setInterval(() => {
                        if (window.authManager && window.apiClient) {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 50);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // 等待authManager初始化
            await waitForAuthManager();

            // 确保用户已登录
            if (!window.authManager.isAuthenticated()) {
                window.location.href = '/login';
                return;
            }

            // 获取日记ID
            const pathParts = window.location.pathname.split('/');
            diaryId = parseInt(pathParts[pathParts.length - 1]);

            if (diaryId) {
                await loadDiaryDetail();
            } else {
                window.location.href = '/diary';
            }
        });

        async function loadDiaryDetail() {
            try {
                const response = await window.apiClient.get(`/diary/${diaryId}`);
                if (response && response.ok) {
                    const data = response.data;
                    displayDiary(data.diary);

                    // 检查是否有分析结果
                    if (data.diary.analysis_status === 'completed' && data.diary.analysis) {
                        displayAnalysis(data.diary.analysis);
                    } else {
                        showPendingAnalysis();
                        startAnalysisRefresh();
                    }
                } else {
                    throw new Error('Failed to load diary');
                }
            } catch (error) {
                console.error('Failed to load diary detail:', error);
                window.showAlert('加载日记详情失败', 'danger');
            }
        }

        function displayDiary(diary) {
            // 更新页面标题和日期
            const date = new Date(diary.created_at);
            document.getElementById('diaryDate').textContent = date.toLocaleString('zh-CN');

            // 更新编辑按钮
            document.getElementById('editBtn').href = `/diary/new?id=${diary.id}`;

            // 显示情绪标签
            const emotionTagsEl = document.getElementById('emotionTags');
            if (diary.emotion_tags && diary.emotion_tags.length > 0) {
                emotionTagsEl.innerHTML = diary.emotion_tags.map(tag =>
                    `<span class="emotion-tag">${tag}</span>`
                ).join('');
            } else {
                emotionTagsEl.innerHTML = '<span class="text-muted">未标记情绪</span>';
            }

            // 显示日记内容
            document.getElementById('diaryContent').textContent = diary.content;

            // 显示图片
            if (diary.images && diary.images.length > 0) {
                const imagesHtml = `
                    <div class="diary-images-gallery mt-3">
                        ${diary.images.map(img =>
                            `<img src="${img}" alt="日记图片" class="diary-image-full">`
                        ).join('')}
                    </div>
                `;
                document.getElementById('diaryContent').insertAdjacentHTML('afterend', imagesHtml);
            }
        }

        function displayAnalysis(analysis) {
            // 隐藏等待分析状态
            document.getElementById('pendingAnalysis').style.display = 'none';

            // 显示分析结果
            document.getElementById('analysisSection').style.display = 'block';
            document.getElementById('cbtInsights').style.display = 'block';

            // 主要情绪
            if (analysis.overall_emotion) {
                document.getElementById('overallEmotion').textContent = analysis.overall_emotion;
            }

            // 情绪强度
            if (analysis.emotion_intensity) {
                document.getElementById('emotionIntensity').textContent =
                    `${analysis.emotion_intensity}/10`;
            }

            // 情绪维度
            if (analysis.emotion_dimensions) {
                const dimensionsEl = document.getElementById('emotionDimensions');
                let html = '';
                for (const [dimension, value] of Object.entries(analysis.emotion_dimensions)) {
                    const percentage = (value * 100).toFixed(0);
                    html += `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>${dimension}</span>
                                <span class="fw-bold">${percentage}%</span>
                            </div>
                            <div class="dimension-bar">
                                <div class="dimension-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }
                dimensionsEl.innerHTML = html;
            }

            // 关键词
            if (analysis.key_words && analysis.key_words.length > 0) {
                const keyWordsEl = document.getElementById('keyWords');
                keyWordsEl.innerHTML = analysis.key_words.map(word =>
                    `<span class="badge bg-info text-dark me-2">${word}</span>`
                ).join('');
            }

            // 置信度
            if (analysis.confidence_score) {
                const confidence = (analysis.confidence_score * 100).toFixed(0);
                document.getElementById('confidenceFill').style.width = `${confidence}%`;
                document.getElementById('confidenceScore').textContent = `${confidence}%`;
            }

            // 生成CBT洞察（模拟数据，实际应该来自AI分析）
            generateCBTInsights(analysis);

            // 停止刷新
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
        }

        function generateCBTInsights(analysis) {
            // 识别的情绪模式
            const patternsEl = document.getElementById('emotionPatterns');
            patternsEl.innerHTML = `
                <p class="mb-0">根据您的日记内容，我们识别出以下情绪模式：</p>
                <ul class="mb-0">
                    <li>您当前的${analysis.overall_emotion || '情绪'}情绪强度为${Math.round((analysis.emotion_intensity || 0) * 10)}%</li>
                    <li>这种情绪模式可能与您的认知思维方式有关</li>
                    <li>建议通过CBT技巧来调整这种思维模式</li>
                </ul>
            `;

            // 可能的认知偏差
            const biasesEl = document.getElementById('cognitiveBiases');
            biasesEl.innerHTML = `
                <p class="mb-0">可能存在的认知偏差：</p>
                <ul class="mb-0">
                    <li><strong>过度概括</strong>：基于单一事件得出广泛结论</li>
                    <li><strong>情绪化推理</strong>：因为感觉某事是真的，就认为它是真的</li>
                    <li><strong>灾难化思维</strong>：把事情想得过分糟糕</li>
                </ul>
            `;

            // 思维重构建议
            const reframingEl = document.getElementById('reframingSuggestions');
            reframingEl.innerHTML = `
                <p class="mb-0">思维重构建议：</p>
                <ol class="mb-0">
                    <li>识别触发情绪的具体想法</li>
                    <li>寻找支持或反驳该想法的证据</li>
                    <li>考虑更平衡、现实的替代想法</li>
                    <li>关注可控因素，制定行动计划</li>
                </ol>
            `;

            // CBT实践建议
            const cbtEl = document.getElementById('cbtSuggestions');
            cbtEl.innerHTML = `
                <p class="mb-0">CBT实践建议：</p>
                <ul class="mb-0">
                    <li>进行"思维记录"练习，每天记录引发情绪的想法</li>
                    <li>尝试"证据收集"：寻找支持不同观点的证据</li>
                    <li>练习"认知重构"：挑战负面思维，寻找替代方案</li>
                    <li>使用"行为实验"：通过实际行动验证新的思维模式</li>
                </ul>
            `;
        }

        function showPendingAnalysis() {
            document.getElementById('pendingAnalysis').style.display = 'block';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('cbtInsights').style.display = 'none';
        }

        function startAnalysisRefresh() {
            refreshTimer = setInterval(async () => {
                try {
                    const response = await window.apiClient.get(`/diary/${diaryId}`);
                    if (response && response.ok) {
                        const data = response.data;
                        if (data.diary.analysis_status === 'completed' && data.diary.analysis) {
                            displayAnalysis(data.diary.analysis);
                        }
                    }
                } catch (error) {
                    console.error('Failed to refresh analysis:', error);
                }
            }, 5000); // 每5秒刷新一次
        }

        function refreshAnalysis() {
            loadDiaryDetail();
        }
    </script>
</body>
</html>