<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç‹ç‹¸çš„æ˜ä¿¡ç‰‡ - CBTæ—¥è®°</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Nunito:wght@400;600;700&display=swap"
        rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        :root {
            --card-rotate: 2deg;
        }

        body {
            font-family: 'Nunito', 'Segoe UI', sans-serif;
            background-color: #f8fafc;
            overflow-x: hidden;
        }

        /* Hero Section */
        .postcard-hero-section {
            position: relative;
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            /* Dreamy Purple/Pink */
            padding: 6rem 0 4rem;
            margin-bottom: 3rem;
            border-radius: 0 0 50% 50% / 40px;
            overflow: hidden;
            text-align: center;
            color: white;
            box-shadow: 0 10px 30px rgba(161, 140, 209, 0.3);
        }

        .postcard-hero-title {
            font-family: 'Fredoka', sans-serif;
            font-weight: 700;
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.1);
            animation: bounceIn 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .postcard-hero-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        /* Floating Decorations */
        .floating-emoji {
            position: absolute;
            font-size: 2.5rem;
            animation: float 6s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
            z-index: 1;
            pointer-events: none;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(-20px) rotate(10deg);
            }
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Postcard Grid */
        .postcards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2.5rem;
            padding: 1rem;
        }

        /* Polaroid Style Card */
        .postcard-item {
            background: white;
            padding: 1rem 1rem 3rem 1rem;
            /* Extra bottom padding for polaroid look */
            border-radius: 4px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            transform: rotate(var(--rotation, 0deg));
            cursor: pointer;
            border: 1px solid #eee;
        }

        .postcard-item:nth-child(even) {
            --rotation: 2deg;
        }

        .postcard-item:nth-child(odd) {
            --rotation: -1.5deg;
        }

        .postcard-item:hover {
            transform: scale(1.05) rotate(0deg) translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        /* Pin/Sticker Decoration */
        .postcard-item::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 35px;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 5;
            /* Tape look */
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.5) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.5) 50%, rgba(255, 255, 255, 0.5) 75%, transparent 75%, transparent);
            background-size: 20px 20px;
            opacity: 0.8;
            border-radius: 2px;
        }

        .postcard-img-wrapper {
            width: 100%;
            height: 220px;
            overflow: hidden;
            border: 1px solid #eee;
            margin-bottom: 1rem;
            background: #f8f9fa;
            position: relative;
        }

        .postcard-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .postcard-item:hover .postcard-img {
            transform: scale(1.1);
        }

        .postcard-content {
            text-align: center;
            color: #555;
            font-family: 'Fredoka', cursive;
            /* Handwritten feel */
        }

        .postcard-location {
            color: #ff6b6b;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .postcard-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #666;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-style: italic;
        }

        /* Status Badges */
        .status-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.8rem;
            z-index: 2;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .status-badge.new {
            background: #ff6b6b;
            color: white;
            transform: rotate(10deg);
        }

        .status-badge.pending {
            background: #f59e0b;
            color: white;
            transform: rotate(-5deg);
        }

        @keyframes popIn {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        /* Empty State */
        .empty-state-game {
            background: white;
            border-radius: 20px;
            padding: 4rem;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            max-width: 600px;
            margin: 2rem auto;
            position: relative;
            overflow: hidden;
        }

        .empty-state-game::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: var(--gradient-candy);
        }

        .empty-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            animation: float 4s ease-in-out infinite;
            display: inline-block;
        }

        /* Back Button */
        .game-back-btn {
            position: fixed;
            top: 2rem;
            left: 2rem;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
            text-decoration: none;
            border: 2px solid transparent;
        }

        .game-back-btn:hover {
            transform: scale(1.1) rotate(-10deg);
            color: var(--primary-pink);
            border-color: var(--primary-pink);
        }

        /* Loading */
        .loading-container {
            text-align: center;
            padding: 4rem;
        }

        .loading-spinner-game {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #a18cd1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        /* Pending State Animation */
        .pending-visual {
            background: #fff8e1;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .fox-walk {
            font-size: 3rem;
            animation: foxWalk 2s infinite linear;
        }

        @keyframes foxWalk {
            0% {
                transform: translateX(-20px) rotate(-5deg);
            }

            25% {
                transform: translateX(0px) rotate(5deg);
            }

            50% {
                transform: translateX(20px) rotate(-5deg);
            }

            75% {
                transform: translateX(0px) rotate(5deg);
            }

            100% {
                transform: translateX(-20px) rotate(-5deg);
            }
        }
    </style>
</head>

<body>
    <!-- Back Button -->
    <a href="/" class="game-back-btn" title="è¿”å›é¦–é¡µ">
        <i class="fas fa-arrow-left"></i>
    </a>

    <!-- Navbar (Hidden but kept for Auth Logic if needed, or we implement simple logic here) -->
    <!-- We will use the main logic to check auth but hide standard navbar for immersion, 
         OR we can include standard navbar. 
         Let's stick to the immersive design with back button for now, 
         as profile page has standard navbar but this is a specific collection page.
         Actually, let's keep the standard navbar for consistency, but maybe transparent on hero?
         Let's stick to the Back Button for a cleaner "Album" feel, standard navbar might break the "Hero" immersion if not careful.
         Profile page had standard navbar. Let's add standard navbar back but transparent?
         The user asked for "similar to homepage". Homepage has navbar.
         Let's add the navbar structure compatible with main.js auth logic.
    -->

    <nav class="navbar navbar-expand-lg fixed-top"
        style="background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <div class="container">
            <a class="navbar-brand" href="/">
                <span class="navbar-logo-emoji">ğŸ’–</span>
                CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/diary">æƒ…ç»ªæ—¥è®°</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/postcards">ğŸ¦Š æ˜ä¿¡ç‰‡</a>
                    </li>
                </ul>
                <div class="d-flex gap-2 align-items-center">
                    <div id="authGuest" class="d-flex gap-2">
                        <a href="/login" class="btn btn-outline-primary rounded-pill px-4">ç™»å½•</a>
                        <a href="/register" class="btn btn-primary rounded-pill px-4">æ³¨å†Œ</a>
                    </div>
                    <div id="authUser" class="d-flex gap-2 align-items-center d-none">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary rounded-pill dropdown-toggle" type="button"
                                id="userDropdown" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="username">ç”¨æˆ·</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-4 mt-2">
                                <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>ä¸ªäººèµ„æ–™</a>
                                </li>
                                <li><a class="dropdown-item" href="/settings"><i class="fas fa-cog me-2"></i>è®¾ç½®</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="javascript:void(0);" id="logoutBtn"><i
                                            class="fas fa-sign-out-alt me-2"></i>é€€å‡ºç™»å½•</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="postcard-hero-section">
        <!-- Floating Emojis -->
        <div class="floating-emoji" style="top: 20%; left: 10%; animation-delay: 0s;">ğŸ¦Š</div>
        <div class="floating-emoji" style="top: 30%; right: 15%; animation-delay: 1.5s;">ğŸ’Œ</div>
        <div class="floating-emoji" style="bottom: 25%; left: 20%; animation-delay: 0.5s;">ğŸŒ</div>
        <div class="floating-emoji" style="top: 15%; right: 10%; animation-delay: 2.5s;">âœ¨</div>
        <div class="floating-emoji" style="bottom: 20%; right: 25%; animation-delay: 1s;">ğŸ“®</div>

        <div class="container" style="position: relative; z-index: 2; margin-top: 3rem;">
            <h1 class="postcard-hero-title">å°æ©˜çš„æ—…è¡Œè¶³è¿¹</h1>
            <p class="postcard-hero-subtitle">
                è¿™é‡Œæ”¶è—äº†å°æ©˜ä»ä¸–ç•Œå„åœ°å¯„æ¥çš„æ˜ä¿¡ç‰‡ã€‚<br>
                æ¯ä¸€æ¬¡æ²»æ„ˆçš„å¯¹è¯ï¼Œéƒ½æ˜¯ä¸€æ®µæ–°çš„æ—…ç¨‹ã€‚
            </p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container mb-5">
        <div id="postcardsList" class="postcards-grid">
            <!-- Loading State -->
            <div class="loading-container" style="grid-column: 1 / -1;">
                <div class="loading-spinner-game"></div>
                <p>æ­£åœ¨æ•´ç†æ˜ä¿¡ç‰‡...</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5 py-4" style="background: white !important; color: #6c757d !important;">
        <div class="container text-center">
            <h5 class="mb-3" style="color: var(--primary-pink) !important;">
                <i class="fas fa-heart-pulse me-2"></i>
                CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆ
            </h5>
            <p class="mb-2" style="color: #6c757d !important;">
                Â© 2024 å¿ƒçµå®ˆæŠ¤è€… - ç”¨çˆ±ä¸ç§‘å­¦ç–—æ„ˆå¿ƒçµ
            </p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check Auth directly or let main.js handle it
            const token = localStorage.getItem('token') || localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
            if (!token) {
                // If main.js doesn't redirect automatically (it usually doesn't on all pages), we enforce it here
                // But main.js usually helps with UI updates. Let's update UI first.
                // Actually main.js handles UI updates but doesn't auto-redirect unless strictly required or checking protected endpoints.
                // We will let the loadPostcards function handle 401.
            }
            loadPostcards();
        });

        async function loadPostcards() {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('/api/postcard/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }

                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const data = await response.json();
                renderPostcards(data.postcards, data.unread_count);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('postcardsList').innerHTML = `
                   <div class="empty-state-game" style="grid-column: 1 / -1;">
                        <div class="empty-icon">ğŸ˜¿</div>
                        <h3>å“å‘€ï¼ŒåŠ è½½å¤±è´¥äº†</h3>
                        <p>ç½‘ç»œå¥½åƒæœ‰ç‚¹å°é—®é¢˜ï¼Œåˆ·æ–°è¯•è¯•çœ‹ï¼Ÿ</p>
                        <button onclick="window.location.reload()" class="btn btn-primary rounded-pill px-4 mt-3">åˆ·æ–°é¡µé¢</button>
                    </div>
                `;
            }
        }

        function renderPostcards(postcards, unreadCount) {
            const container = document.getElementById('postcardsList');

            if (!postcards || postcards.length === 0) {
                container.innerHTML = `
                    <div class="empty-state-game" style="grid-column: 1 / -1;">
                        <div class="empty-icon">ğŸ—ºï¸</div>
                        <h3>è¿˜æ²¡æœ‰æ”¶åˆ°æ˜ä¿¡ç‰‡</h3>
                        <p class="text-muted mb-4">
                            å°æ©˜è¿˜åœ¨å‡†å¤‡è¡Œæå‘¢ï¼<br>
                            å†™ä¸€ç¯‡æ—¥è®°ï¼Œè¿™åªå°ç‹ç‹¸å°±ä¼šå‡ºå‘å»ä¸ºä½ å¯»æ‰¾æ²»æ„ˆçš„é£æ™¯ã€‚
                        </p>
                        <a href="/diary/new" class="btn btn-primary btn-lg rounded-pill pulse-animation">
                            <i class="fas fa-pen-fancy me-2"></i>
                            å»å†™æ—¥è®°
                        </a>
                    </div>
                 `;
                return;
            }

            container.innerHTML = postcards.map(postcard => {
                const isPending = postcard.status === 'pending';
                const isUnread = !postcard.is_read && !isPending;

                // Image handling
                let imageHtml;
                if (isPending) {
                    imageHtml = `
                        <div class="pending-visual">
                            <div class="fox-walk">ğŸ¦Š</div>
                            <small class="text-muted mt-2">å°æ©˜é€ä¿¡ä¸­...</small>
                        </div>
                     `;
                } else if (postcard.image_url) {
                    imageHtml = `<img src="${postcard.image_url}" alt="${postcard.location_name}" class="postcard-img" loading="lazy">`;
                } else {
                    // Fallback placeholder
                    imageHtml = `
                        <div class="pending-visual" style="background: #eef2ff;">
                            <div style="font-size: 3rem;">ğŸï¸</div>
                        </div>
                      `;
                }

                // Location & Message
                const location = postcard.location_name || 'æœªçŸ¥ç§˜å¢ƒ';
                const message = isPending ? 'å°æ©˜æ­£åœ¨ç¿»å±±è¶Šå²­ä¸ºä½ é€ä¿¡...' : (postcard.message || 'ï¼ˆç©ºç™½æ˜ä¿¡ç‰‡ï¼‰');
                const date = formatDate(postcard.created_at);

                return `
                    <div class="postcard-item animate-fade-in-up" onclick="viewPostcard(${postcard.id})">
                        ${isUnread ? '<div class="status-badge new">NEW!</div>' : ''}
                        ${isPending ? '<div class="status-badge pending">é€ä¿¡ä¸­</div>' : ''}
                        
                        <div class="postcard-img-wrapper">
                            ${imageHtml}
                        </div>
                        
                        <div class="postcard-content">
                            <div class="postcard-location">
                                <i class="fas fa-map-marker-alt"></i> ${location}
                            </div>
                            <div class="postcard-text">
                                "${message}"
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="far fa-clock me-1"></i> ${date}
                            </small>
                        </div>
                    </div>
                 `;
            }).join('');
        }

        function viewPostcard(id) {
            window.location.href = `/postcard/${id}`;
        }

        // Helper function for date formatting
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                month: 'long',
                day: 'numeric'
            });
        }
    </script>
</body>

</html>