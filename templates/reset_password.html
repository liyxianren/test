<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡ç½®å¯†ç  - CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆ</title>
    <meta name="description" content="é‡ç½®æ‚¨çš„CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆè´¦å·å¯†ç ">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="alternate icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <span class="navbar-logo-emoji">ğŸ’–</span>
                CBTæƒ…ç»ªæ—¥è®°æ¸¸æˆ
            </a>
            <div class="d-flex gap-2">
                <a href="/login" class="btn btn-outline">è¿”å›ç™»å½•</a>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-5 col-md-7">
                    <!-- é‡ç½®å¯†ç è¡¨å• -->
                    <div class="form-container animate-fade-in-up">
                        <div class="text-center mb-4">
                            <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3"
                                 style="width: 80px; height: 80px; background: var(--gradient-primary);">
                                <i class="fas fa-key text-white" style="font-size: 2rem;"></i>
                            </div>
                            <h1 class="form-title">é‡ç½®å¯†ç </h1>
                            <p class="text-gray-600">
                                è¯·è®¾ç½®æ‚¨çš„æ–°å¯†ç ï¼Œç¡®ä¿è´¦å·å®‰å…¨
                            </p>
                        </div>

                        <!-- é”™è¯¯/æˆåŠŸæç¤º -->
                        <div id="alertContainer"></div>

                        <form id="resetPasswordForm" novalidate>
                            <!-- æ–°å¯†ç  -->
                            <div class="form-group">
                                <label for="newPassword" class="form-label">
                                    <i class="fas fa-lock me-2"></i>æ–°å¯†ç 
                                </label>
                                <div class="input-group">
                                    <input type="password"
                                           class="form-control"
                                           id="newPassword"
                                           name="new_password"
                                           placeholder="è¯·è¾“å…¥æ–°å¯†ç "
                                           required
                                           minlength="6">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                        <i class="fas fa-eye" id="newPasswordIcon"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback">
                                    å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦
                                </div>
                                <div class="mt-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small class="text-gray-600">å¯†ç å¼ºåº¦</small>
                                        <small id="newStrengthText" class="text-gray-500">--</small>
                                    </div>
                                    <div class="progress" style="height: 4px;">
                                        <div id="newStrengthBar" class="progress-bar" role="progressbar"
                                             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ç¡®è®¤æ–°å¯†ç  -->
                            <div class="form-group">
                                <label for="confirmNewPassword" class="form-label">
                                    <i class="fas fa-lock me-2"></i>ç¡®è®¤æ–°å¯†ç 
                                </label>
                                <div class="input-group">
                                    <input type="password"
                                           class="form-control"
                                           id="confirmNewPassword"
                                           name="confirm_new_password"
                                           placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
                                           required>
                                    <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                        <i class="fas fa-eye" id="confirmPasswordIcon"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback">
                                    ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´
                                </div>
                            </div>

                            <!-- é‡ç½®æŒ‰é’® -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="resetBtn">
                                    <i class="fas fa-check me-2"></i>
                                    <span id="resetBtnText">ç¡®è®¤é‡ç½®å¯†ç </span>
                                </button>
                            </div>

                            <!-- å®‰å…¨æç¤º -->
                            <div class="alert alert-info mt-3 mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>
                                    å¯†ç å®‰å…¨æç¤ºï¼š<br>
                                    â€¢ ä½¿ç”¨è‡³å°‘6ä¸ªå­—ç¬¦<br>
                                    â€¢ åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦<br>
                                    â€¢ é¿å…ä½¿ç”¨å¸¸è§çš„å¯†ç æ¨¡å¼
                                </small>
                            </div>
                        </form>

                        <!-- è¿”å›ç™»å½•é“¾æ¥ -->
                        <div class="text-center mt-4">
                            <p class="text-gray-600 mb-0">
                                æƒ³èµ·å¯†ç äº†ï¼Ÿ
                                <a href="/login" class="text-primary text-decoration-none fw-semibold">
                                    è¿”å›ç™»å½•
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script>
        // è·å–URLä¸­çš„token
        const urlParams = new URLSearchParams(window.location.search);
        const token = "{{ token }}"; // ä»æ¨¡æ¿å˜é‡è·å–token

        // å¯†ç æ˜¾ç¤º/éšè—åˆ‡æ¢
        function setupPasswordToggle(toggleId, inputId, iconId) {
            const toggleBtn = document.getElementById(toggleId);
            const passwordInput = document.getElementById(inputId);
            const passwordIcon = document.getElementById(iconId);

            if (toggleBtn && passwordInput && passwordIcon) {
                toggleBtn.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    passwordIcon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
                });
            }
        }

        setupPasswordToggle('toggleNewPassword', 'newPassword', 'newPasswordIcon');
        setupPasswordToggle('toggleConfirmPassword', 'confirmNewPassword', 'confirmPasswordIcon');

        // å¯†ç å¼ºåº¦æ£€æµ‹
        function checkPasswordStrength(password) {
            let strength = 0;
            const strengthBar = document.getElementById('newStrengthBar');
            const strengthText = document.getElementById('newStrengthText');

            if (password.length >= 6) strength++;
            if (password.length >= 10) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            const strengthLevels = [
                { width: '0%', color: 'bg-danger', text: 'å¼±' },
                { width: '20%', color: 'bg-danger', text: 'å¾ˆå¼±' },
                { width: '40%', color: 'bg-warning', text: 'ä¸€èˆ¬' },
                { width: '60%', color: 'bg-info', text: 'è¾ƒå¼º' },
                { width: '80%', color: 'bg-primary', text: 'å¼º' },
                { width: '100%', color: 'bg-success', text: 'å¾ˆå¼º' }
            ];

            const level = strengthLevels[strength] || strengthLevels[0];
            strengthBar.style.width = level.width;
            strengthBar.className = `progress-bar ${level.color}`;
            strengthBar.setAttribute('aria-valuenow', parseInt(level.width));
            strengthText.textContent = level.text;
            strengthText.className = level.color.replace('bg-', 'text-');
        }

        // è¡¨å•éªŒè¯
        const resetPasswordForm = document.getElementById('resetPasswordForm');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');

        newPasswordInput.addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });

        function validateResetForm() {
            let isValid = true;

            // æ–°å¯†ç éªŒè¯
            if (newPasswordInput.value.length < 6) {
                newPasswordInput.classList.add('is-invalid');
                isValid = false;
            } else {
                newPasswordInput.classList.remove('is-invalid');
            }

            // ç¡®è®¤å¯†ç éªŒè¯
            if (confirmNewPasswordInput.value !== newPasswordInput.value) {
                confirmNewPasswordInput.classList.add('is-invalid');
                isValid = false;
            } else {
                confirmNewPasswordInput.classList.remove('is-invalid');
            }

            return isValid;
        }

        // å®æ—¶éªŒè¯
        ['newPassword', 'confirmNewPassword'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('blur', function() {
                validateResetForm();
            });
        });

        // è¡¨å•æäº¤
        resetPasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!validateResetForm()) {
                showAlert('è¯·æ£€æŸ¥å¹¶ä¿®æ­£è¡¨å•ä¸­çš„é”™è¯¯', 'danger');
                return;
            }

            if (!token) {
                showAlert('æ— æ•ˆçš„é‡ç½®é“¾æ¥', 'danger');
                return;
            }

            const resetBtn = document.getElementById('resetBtn');
            const resetBtnText = document.getElementById('resetBtnText');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resetBtn.disabled = true;
            resetBtnText.innerHTML = '<span class="loading me-2"></span>é‡ç½®ä¸­...';

            try {
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        reset_token: token,
                        new_password: newPasswordInput.value
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('å¯†ç é‡ç½®æˆåŠŸï¼æ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...', 'success');

                    // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    showAlert(data.error || 'é‡ç½®å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
                }
            } catch (error) {
                console.error('Reset password error:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'danger');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                resetBtn.disabled = false;
                resetBtnText.innerHTML = '<i class="fas fa-check me-2"></i>ç¡®è®¤é‡ç½®å¯†ç ';
            }
        });

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);

            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // è¾“å…¥æ—¶æ¸…é™¤é”™è¯¯çŠ¶æ€
        document.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
        });

        // é¡µé¢åŠ è½½åŠ¨ç”»
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelector('.form-container').classList.add('animate-fade-in-up');

            // æ£€æŸ¥tokenæ˜¯å¦å­˜åœ¨
            if (!token) {
                showAlert('æ— æ•ˆçš„é‡ç½®é“¾æ¥ï¼Œè¯·é‡æ–°ç”³è¯·', 'danger');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 3000);
            }
        });
    </script>
</body>
</html>